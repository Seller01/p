<template>
    <b-tabs>
        <b-tab v-for="c in langs" :key="c.code" align="center" active-nav-item-class="font-weight-bold">
            <template slot="title">
                <img :src="`${flagsPath}${c.code.toUpperCase()}.svg`" style="width: 32px;height: 32px" />
                &nbsp;{{c.name}}
            </template>
            <w-block-editor
                v-model="translations[c.code]"
                :culture="c.code"
                :modules="modules"
                :can-add="false"
                :can-delete="false"
                :can-delete-all="false"
            ></w-block-editor>
        </b-tab>
    </b-tabs>
</template>

<script>
export default {
    props: {
        // array of {culture, content}
        value: {
            type: Array,
            default() {
                return [];
            }
        },
        /**
         * array of enabled modules (vue components) and their config [
         *      {
         *          type: '',       //module type
         *          config: {},     //module config
         *      }
         * ]
         */
        modules: {
            type: Array,
            default() {
                return [];
            }
        },
        textToBlock: {
            type: Function
        },
        // array of {code, direction, name}
        langs: {
            default() {
                return [];
            }
        }
    },
    data() {
        return {
            flagsPath: '/culture-flags/',
            translations: {}
        };
    },
    mounted() {
        this.valueChanged();
    },
    methods: {
        valueToObject() {
            var v;
            if (this.value === undefined || this.value === null) {
                v = [];
            } else {
                v = this.value;
            }
            var res = {};
            this.langs.forEach(culture => {
                var text = '';
                var item = v.find(a => a.culture === culture.code);
                if (item !== undefined && item !== null) {
                    text = item.content;
                }
                var block;
                if (this.textToBlock === undefined || this.textToBlock === null) {
                    block = {
                        type: 'text',
                        data: {
                            text: text
                        }
                    };
                } else {
                    block = this.textToBlock(text);
                }
                res[culture.code] = {
                    blocks: [block]
                };
            });
            return res;
        },
        translationsToArray() {
            var res = [];
            Object.keys(this.translations).forEach(culture => {
                var blocks = this.translations[culture].blocks;
                var text = blocks.length > 0 ? blocks[0].data.text : '';
                res.push({
                    culture: culture,
                    content: text
                });
            })
            return res;
        },
        valueChanged() {
            var o = this.valueToObject();
            if (!_.isEqual(this.translations, o)) {
                this.translations = Object.assign({}, o);
            }
        }
    },
    watch: {
        value: {
            handler() {
                this.valueChanged();
            },
            deep: true
        },
        translations: {
            handler() {
                var v = this.translationsToArray();
                if (!_.isEqual(this.value, v)) {
                    this.$emit('input', v);
                }
            },
            deep: true
        }
    }
}
</script>