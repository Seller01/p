<template>
    <b-card :title="$t('recover-password-tab-title')">
        <w-verify-code
            v-model="verifying"
            :type="verificationType"
            :email="email"
            :phone="phone"
            :request-url="requestUrl"
            :verify-url="verifyUrl"
            @done="verified"
        ></w-verify-code>
        <div v-show="canResetPasswordWithPhone">
            <b-form-group
                :label="$t('phone-number')"
                label-for="reset-password-phone"
                :invalid-feedback="invalidPhone"
                :state="phoneState"
            >
                <w-phone-input v-model="phone" :disabled="readyToResetPassword"></w-phone-input>
            </b-form-group>
            <b-button
                block
                class="mt-3"
                variant="primary"
                @click="verifyPhone"
                v-show="!readyToResetPassword && phoneState"
            >{{$t('reset-password-verify-phone')}}</b-button>
        </div>
        <hr class="my-5" v-show="canResetPasswordWithPhone && canResetPasswordWithEmail" />
        <div v-show="canResetPasswordWithEmail">
            <b-form-group
                :label="$t('email')"
                label-for="reset-password-email"
                :invalid-feedback="invalidEmail"
                :state="emailState"
            >
                <b-form-input v-model="email" id="reset-password-email" dir="ltr" :disabled="readyToResetPassword"></b-form-input>
            </b-form-group>
            <b-button
                block
                class="mt-3"
                variant="primary"
                @click="verifyEmail"
                v-show="!readyToResetPassword && emailState"
            >{{$t('reset-password-verify-email')}}</b-button>
        </div>
        <hr class="my-2" v-show="readyToResetPassword" />
        <div v-show="readyToResetPassword">
            <b-form-group
                :label="$t('password')"
                label-for="reset-password-password"
                :invalid-feedback="invalidPassword"
                :state="passwordState"
            >
                <b-form-input
                    type="password"
                    id="reset-password-password"
                    v-model="password"
                    :disabled="resettingPassword"
                ></b-form-input>
            </b-form-group>
            <b-form-group
                :label="$t('confirm-password')"
                label-for="reset-password-confirm-password"
                :invalid-feedback="invalidConfirmPassword"
                :state="confirmPasswordState"
            >
                <b-form-input
                    type="password"
                    id="reset-password-confirm-password"
                    v-model="confirmPassword"
                    :disabled="resettingPassword"
                ></b-form-input>
            </b-form-group>
            <b-button
                block
                class="mt-3"
                variant="primary"
                @click="resetPassword"
                :disabled="resettingPassword"
            >{{$t('save')}}</b-button>
        </div>
    </b-card>
</template>

<script>
import { isEmail, isNumber } from "./util";
import { UrlParser } from "../../utility/url";
export default {
    props: {
        canResetPasswordWithEmail: {
            default: false
        },
        canResetPasswordWithPhone: {
            default: false
        }
    },
    data() {
        return {
            email: '',
            phone: {
                phone: '',
                countryCode: 'IR'
            },
            verifying: false,
            verificationType: '',
            readyToResetPassword: false,
            password: '',
            confirmPassword: '',
            resettingPassword: false
        };
    },
    methods: {
        verifyPhone() {
            if (!isNumber(this.phone.phone)) {
                this.toastError(this.$t('invalid-phone'));
                return;
            }
            this.verificationType = 'phone';
            this.verifying = true;
        },
        verifyEmail() {
            if (!isEmail(this.email)) {
                this.toastError(this.$t('invalid-email'));
                return;
            }
            this.verificationType = 'email';
            this.verifying = true;
        },
        verified() {
            this.readyToResetPassword = true;
        },
        async resetPassword() {
            try {
                this.resettingPassword = true;
                var args = {
                    password: this.password,
                    confirmPassword: this.confirmPassword,
                    type: this.verificationType === 'email' ? 'Email' : 'Phone',
                    email: this.email,
                    phoneNumber: this.phone.phone,
                    phoneCountryCode: this.phone.countryCode
                };
                await this.$api.post('/api/usermanager/Account/ResetPassword', args);
                this.toastSuccess();
                this.$emit('done');
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.resettingPassword = false;
            }
        }
    },
    computed: {
        requestUrl() {
            const urlParser = new UrlParser();
            if (this.verificationType === 'email') {
                return urlParser.localizeUrl('/api/usermanager/Account/SendRequestCodeForResetPasswordToEmail').toRelative();
            }
            return urlParser.localizeUrl('/api/usermanager/Account/SendRequestCodeForResetPasswordToPhone').toRelative();
        },
        verifyUrl() {
            const urlParser = new UrlParser();
            if (this.verificationType === 'email') {
                return urlParser.localizeUrl('/api/usermanager/Account/VerifyCodeSentForResetPasswordToEmail').toRelative();
            }
            return urlParser.localizeUrl('/api/usermanager/Account/VerifyCodeSentForResetPasswordToPhone').toRelative();
        },
        phoneState() {
            var p = this.phone;
            return p !== undefined && p !== null && p.phone !== undefined && p.phone !== null && isNumber(p.phone);
        },
        invalidPhone() {
            if (this.phoneState) {
                return '';
            }
            return this.$t('invalid-phone');
        },
        emailState() {
            return this.email !== undefined && this.email !== null && this.email.length > 0 && isEmail(this.email);
        },
        invalidEmail() {
            if (this.emailState) {
                return '';
            }
            return this.$t('invalid-email');
        },
        passwordState() {
            return this.password !== undefined && this.password !== null && this.password.length > 0;
        },
        invalidPassword() {
            if (this.passwordState) {
                return '';
            }
            return this.$t('password-required');
        },
        confirmPasswordState() {
            return this.confirmPassword !== undefined && this.confirmPassword !== null && this.confirmPassword.length > 0;
        },
        invalidPasswordState() {
            if (this.confirmPasswordState) {
                return '';
            }
            return this.$t('confirm-password-required');
        },
        confirmPasswordState() {
            return this.confirmPassword !== undefined && this.confirmPassword !== null && this.confirmPassword.length > 0;
        },
        invalidConfirmPassword() {
            if (this.confirmPasswordState) {
                return '';
            }
            return this.$t('confirm-password-required');
        }
    }
}
</script>