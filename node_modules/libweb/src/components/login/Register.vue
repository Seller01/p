<template>
    <b-card :title="$t('register-tab-title')">
        <w-verify-code
            v-model="verifying"
            :type="verificationType"
            :email="email"
            :phone="phone"
            :request-url="requestUrl"
            :verify-url="verifyUrl"
            @done="verified"
        ></w-verify-code>
        <div v-show="canRegisterWithPhone">
            <b-form-group
                :label="$t('register-with-phone')"
                label-for="register-phone"
                :invalid-feedback="invalidPhone"
                :state="phoneState"
            >
                <w-phone-input v-model="phone" :disabled="readyToRegister"></w-phone-input>
            </b-form-group>
            <b-button
                block
                class="mt-3"
                variant="primary"
                @click="verifyPhone"
                v-show="!readyToRegister && phoneState"
            >{{$t('register-verify-phone')}}</b-button>
        </div>
        <hr class="my-5" v-show="canRegisterWithPhone && canRegisterWithEmail" />
        <div v-show="canRegisterWithEmail">
            <b-form-group
                :label="$t('register-with-email')"
                label-for="register-email"
                :invalid-feedback="invalidEmail"
                :state="emailState"
            >
                <b-form-input v-model="email" id="register-email" dir="ltr" :disabled="readyToRegister"></b-form-input>
            </b-form-group>
            <b-button
                block
                class="mt-3"
                variant="primary"
                @click="verifyEmail"
                v-show="!readyToRegister && emailState"
            >{{$t('register-verify-email')}}</b-button>
        </div>
        <hr class="my-2" v-show="readyToRegister" />
        <div v-show="readyToRegister">
            <b-form-group
                :label="$t('user-name')"
                label-for="register-user-name"
                :invalid-feedback="invalidUserName"
                :state="usernameState"
            >
                <b-form-input trim id="register-user-name" v-model="username" dir="ltr"></b-form-input>
            </b-form-group>
            <b-form-group
                :label="$t('name')"
                label-for="register-name"
                :invalid-feedback="invalidName"
                :state="nameState"
            >
                <b-form-input trim id="register-name" v-model="name"></b-form-input>
            </b-form-group>
            <b-form-group
                :label="$t('password')"
                label-for="register-password"
                :invalid-feedback="invalidPassword"
                :state="passwordState"
            >
                <b-form-input
                    type="password"
                    id="register-password"
                    v-model="password"
                    :disabled="registering"
                    dir="ltr"
                ></b-form-input>
            </b-form-group>
            <b-form-group
                :label="$t('confirm-password')"
                label-for="register-confirm-password"
                :invalid-feedback="invalidConfirmPassword"
                :state="confirmPasswordState"
            >
                <b-form-input
                    type="password"
                    id="register-confirm-password"
                    v-model="confirmPassword"
                    :disabled="registering"
                    dir="ltr"
                ></b-form-input>
            </b-form-group>
            <b-form-group :label="$t('birth-date')" label-for="register-birth-date">
                <w-date-picker v-model="birthDateMs" type="date" :disabled="registering"></w-date-picker>
            </b-form-group>
            <b-form-group :label="$t('gender')" label-for="register-gender">
                <b-form-select id="register-gender" v-model="gender" :options="genders" :disabled="registering"></b-form-select>
            </b-form-group>
            <b-button block class="mt-3" variant="primary" @click="register" :disabled="registering">{{$t('register')}}</b-button>
        </div>
    </b-card>
</template>

<script>
import { isEmail, isNumber } from "./util";
import { UrlParser } from "../../utility/url";
export default {
    props: {
        canRegisterWithEmail: {
            default: false
        },
        canRegisterWithPhone: {
            default: false
        },
        usernameRequired: {
            default: true
        }
    },
    data() {
        return {
            email: '',
            phone: {
                phone: '',
                countryCode: 'IR'
            },
            verifying: false,
            verificationType: '',
            readyToRegister: false,
            password: '',
            confirmPassword: '',
            username: '',
            name: '',
            birthDateMs: moment().add('years', -30).valueOf(),
            gender: 'male',
            genders: [
                { text: this.$t('male'), value: 'male' },
                { text: this.$t('female'), value: 'female' },
            ],
            registering: false
        };
    },
    methods: {
        verifyPhone() {
            if (!isNumber(this.phone.phone)) {
                this.toastError(this.$t('invalid-phone'));
                return;
            }
            this.verificationType = 'phone';
            this.verifying = true;
        },
        verifyEmail() {
            if (!isEmail(this.email)) {
                this.toastError(this.$t('invalid-email'));
                return;
            }
            this.verificationType = 'email';
            this.verifying = true;
        },
        verified() {
            this.readyToRegister = true;
        },
        async register() {
            try {
                this.registering = true;
                var args = {
                    password: this.password,
                    confirmPassword: this.confirmPassword,
                    type: this.verificationType === 'email' ? 'Email' : 'Phone',
                    email: this.email,
                    phoneNumber: this.phone.phone,
                    phoneNumberCountryCode: this.phone.countryCode,
                    userName: this.username,
                    isMale: this.gender === null ? null : this.gender === 'male',
                    name: this.name,
                    birthDateMs: this.birthDateMs
                };
                await this.$api.post('/api/usermanager/Account/Register', args);
                this.toastSuccess();
                this.$emit('done');
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.registering = false;
            }
        }
    },
    computed: {
        requestUrl() {
            const urlParser = new UrlParser();
            if (this.verificationType === 'email') {
                return urlParser.localizeUrl('/api/usermanager/Account/SendRequestCodeForRegistrationToEmail').toRelative();
            }
            return urlParser.localizeUrl('/api/usermanager/Account/SendRequestCodeForRegistrationToPhone').toRelative();
        },
        verifyUrl() {
            const urlParser = new UrlParser();
            if (this.verificationType === 'email') {
                return urlParser.localizeUrl('/api/usermanager/Account/VerifyCodeSentForRegistrationToEmail').toRelative();
            }
            return urlParser.localizeUrl('/api/usermanager/Account/VerifyCodeSentForRegistrationToPhone').toRelative();
        },
        phoneState() {
            var p = this.phone;
            return p !== undefined && p !== null && p.phone !== undefined && p.phone !== null && isNumber(p.phone);
        },
        invalidPhone() {
            if (this.phoneState) {
                return '';
            }
            return this.$t('invalid-phone');
        },
        emailState() {
            return this.email !== undefined && this.email !== null && this.email.length > 0 && isEmail(this.email);
        },
        invalidEmail() {
            if (this.emailState) {
                return '';
            }
            return this.$t('invalid-email');
        },
        usernameState() {
            return this.usernameRequired && this.username !== undefined && this.username !== null && this.username.length > 0;
        },
        invalidUserName() {
            if (this.usernameState) {
                return '';
            }
            return this.$t('username-required');
        },
        nameState() {
            return this.name !== undefined && this.name !== null && this.name.length > 0;
        },
        invalidName() {
            if (this.nameState) {
                return '';
            }
            return this.$t('name-required');
        },
        passwordState() {
            return this.password !== undefined && this.password !== null && this.password.length > 0;
        },
        invalidPassword() {
            if (this.passwordState) {
                return '';
            }
            return this.$t('password-required');
        },
        confirmPasswordState() {
            return this.confirmPassword !== undefined && this.confirmPassword !== null && this.confirmPassword.length > 0;
        },
        invalidConfirmPassword() {
            if (this.confirmPasswordState) {
                return '';
            }
            return this.$t('confirm-password-required');
        }
    }
}
</script>