<template>
    <b-card :title="$t('login-tab-title')">
        <form onsubmit="return false;">
            <b-form-group
                :label="$t('user-name-label')"
                :label-for="loginType === 'username' ? 'login_userName' : 'login_email'"
            >
                <w-phone-input v-show="loginType === 'phone'" v-model="phone" ref="phone" input-name="username"></w-phone-input>
                <b-form-input
                    id="login_userName"
                    v-show="loginType === 'username'"
                    v-model="userName"
                    dir="ltr"
                    ref="username"
                    input-name="username"
                    autofocus
                ></b-form-input>
                <b-form-input
                    id="login_email"
                    v-show="loginType === 'email'"
                    v-model="email"
                    dir="ltr"
                    ref="email"
                    input-name="username"
                ></b-form-input>
            </b-form-group>
            <b-form-group :label="$t('password-label')" label-for="login_password">
                <b-form-input id="login_password" v-model="password" type="password" dir="ltr"></b-form-input>
            </b-form-group>
            <b-button variant="primary" block class="mt-3" @click="onLoginButton">{{$t('login-button-label')}}</b-button>
        </form>
    </b-card>
</template>

<script>
import { isEmail, isNumber } from "./util";
export default {
    props: {
        returnUrl: {
            default: ''
        },
    },
    data() {
        return {
            loginType: 'username',      // username, phone, email
            userName: '',
            phone: {
                phone: '',
                countryCode: 'IR'
            },
            email: '',
            password: '',
        };
    },
    methods: {
        changeLoginType(type) {
            this.loginType = type;
            this.$nextTick(() => {
                this.$refs[type].focus();
            });
        },
        getLoginValue() {
            if (this.loginType === 'email') {
                return this.email;
            }
            if (this.loginType === 'phone') {
                return this.phone.phone;
            }
            return this.userName;
        },
        async onLoginButton() {
            try {
                await this.$api.post('/api/usermanager/account/login', {
                    returnUrl: this.returnUrl,
                    type: 'userName',
                    emailOrPhoneNumberOrUserName: this.getLoginValue(),
                    password: this.password,
                    phoneCountryCode: this.phone.countryCode
                });
            } catch (error) {
                this.toastError(error);
                console.error(error);
            }
        }
    },
    watch: {
        'userName': {
            handler() {
                var u = this.userName;
                if (u === undefined || u === null || u.length === 0) {
                    return;
                }

                if (isEmail(u)) {
                    this.email = u;
                    this.changeLoginType('email');
                    return;
                }

                if (isNumber(u)) {
                    this.phone.phone = u;
                    this.changeLoginType('phone');
                    return;
                }
            }
        },
        'email': {
            handler() {
                var e = this.email;
                if (e === undefined || e === null || e.length === 0) {
                    this.userName = e;
                    this.changeLoginType('username');
                    return;
                }

                if (isNumber(e)) {
                    this.phone.phone = e;
                    this.changeLoginType('phone');
                    return;
                }

                if (!isEmail(e)) {
                    this.userName = e;
                    this.changeLoginType('username');
                    return;
                }
            }
        },
        'phone.phone': {
            handler() {
                var p = this.phone.phone;
                if (p === undefined || p === null || p.length === 0) {
                    this.userName = p;
                    this.changeLoginType('username');
                    return;
                }

                if (isEmail(p)) {
                    this.email = p;
                    this.changeLoginType('email');
                    return;
                }

                if (!isNumber(p)) {
                    this.userName = p;
                    this.changeLoginType('username');
                    return;
                }
            }
        }
    }
}
</script>