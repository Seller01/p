<template>
    <span>
        <input
            class="form-control"
            type="text"
            :id="id"
            :name="name"
            @focus="openDte"
            v-model="formattedDateTime"
            readonly
            style="cursor: pointer !important"
        />
        <date-picker
            v-model="dateTime"
            :show="visible"
            :display-format="displayFormat"
            :format="format"
            :locale-config="localeConfig"
            :view="view"
            :jump-minute="jumpMinute"
            :round-minute="roundMinute"
            :type="type"
            :locale="locale"
            :element="id"
            :disabled="disabled"
            :min="minDateTime"
            :max="maxDateTime"
            @open="() => visible = true"
            @close="() => visible = false"
        ></date-picker>
    </span>
</template>

<script>
import { guid } from "../../utility/guid";
import { ServerValues } from "../../utility/ServerValues";
export default {
    components: {
        'date-picker': VuePersianDatetimePicker
    },
    props: {
        name: {
            type: String,
            default: ''
        },
        value: {
            type: Number,
            default: moment().valueOf()
        },
        view: {
            type: String,
            default: 'day'     //day, month, year, time
        },
        type: {
            type: String,
            default: 'datetime', //datetime, date, year, month, time
        },
        disabled: {
            type: Boolean,
            default: false
        },
        jumpMinute: {
            type: Number,
            default: 1
        },
        roundMinute: {
            type: Boolean,
            default: false
        },
        min: {
            type: Number,
            default: null
        },
        max: {
            type: Number,
            default: null
        },
        formats: {
            type: Object,
            default() {
                return {
                    fa: 'dddd jDD jMMMM jYYYY HH:mm',
                    en: 'dddd DD MMMM YYYY HH:mm'
                }
            }
        }
    },
    data() {
        const culture = new ServerValues().getValues()['culture'];
        return {
            culture: culture,
            id: guid.newId(),
            format: 'YYYY/MM/DD HH:mm:ss',
            dateTime: '',
            formattedDateTime: moment(this.value).locale(culture).format(this.displayFormat),
            minDateTime: '',
            maxDateTime: '',
            visible: false,
            localeConfig: {
                fa: {
                    dow: 6,     //  first day of week
                    dir: 'rtl',
                    displayFormat: this.formats.fa,
                    lang: {
                        label: 'شمسی',
                        submit: 'تایید',
                        cancel: 'انصراف',
                        now: 'اکنون',
                        nextMonth: 'ماه بعد',
                        prevMonth: 'ماه قبل',
                    }
                },
                en: {
                    dow: 0,
                    dir: 'ltr',
                    displayFormat: this.formats.en,
                    lang: {
                        label: 'Gregorian',
                        submit: 'Select',
                        cancel: 'Cancel',
                        now: 'Now',
                        nextMonth: 'Next month',
                        prevMonth: 'Previous month',
                    }
                }
            }
        };
    },
    mounted() {
        this.setDateTime(this.value);
        this.setMinDateTime(this.min);
        this.setMaxDateTime(this.max);
    },
    computed: {
        locale() {
            return this.culture === 'fa' ? 'fa,en' : 'en,fa';
        },
        displayFormat() {
            return this.culture === 'fa' ? this.formats.fa : this.formats.en;
        }
    },
    methods: {
        getMs() {
            return moment(this.dateTime, this.format).valueOf();
        },
        setDateTime(ms) {
            this.dateTime = moment(ms).locale('en').format(this.format);
        },
        setMinDateTime(ms) {
            if (ms === undefined || ms === null) {
                this.minDateTime = null;
            } else {
                this.minDateTime = moment(ms).locale('en').format(this.format);
            }
        },
        setMaxDateTime(ms) {
            if (ms === undefined || ms === null) {
                this.maxDateTime = null;
            } else {
                this.maxDateTime = moment(ms).locale('en').format(this.format);
            }
        },
        openDte() {
            this.visible = true;
        }
    },
    watch: {
        value() {
            var v = this.getMs();
            if (this.value != v) {
                this.setDateTime(this.value);
            }
        },
        dateTime() {
            var culture = this.culture;
            this.formattedDateTime = moment(this.dateTime, this.format).locale(culture).format(this.displayFormat);
            var v = this.getMs();
            if (this.value != v) {
                this.$emit('input', v);
            }
        },
        min() {
            this.setMinDateTime(this.min);
        },
        max() {
            this.setMaxDateTime(this.max);
        }
    }
}
</script>