<template>
    <b-modal v-model="visible" no-close-on-backdrop no-close-on-esc hide-footer size="md" :title="title">
        <center style="font-size: larger">
            <div v-if="requestResult.flag !== 'None' && requestResult.flag !== 'Error'">
                <b
                    :style="{'color': requestResult.flag === 'NewCodeSent' || requestResult.flag === 'CodeWasSentBefore' ? 'green' : 'red'}"
                >{{$t(requestResult.flag)}}</b>
                <w-count-down
                    v-if="requestResult.flag === 'NewCodeSent' || requestResult.flag === 'CodeWasSentBefore'"
                    :end-date-ms="endDateMs"
                ></w-count-down>
            </div>
        </center>
        <b-button
            :disabled="requestingCode || verifyingCode"
            variant="info"
            class="my-4"
            @click="requestCode"
        >{{$t('resend-code')}}</b-button>
        <b-form-input
            v-model="code"
            :disabled="requestingCode || verifyingCode"
            :placeholder="$t('verification-code')"
            dir="ltr"
        ></b-form-input>
        <p v-if="verifiyingCodeIsWrong" v-html="verifiyingError" style="color: red" class="my-3"></p>
        <b-button
            class="mt-3"
            block
            :disabled="requestingCode || verifyingCode"
            variant="success"
            @click="verifyCode"
        >{{$t('verify-code')}}</b-button>
    </b-modal>
</template>
<script>
import loc from './WVerifyCode.i18n.json';
import { i18n } from "../../utility/VueI18n";
export default {
    i18n: i18n(loc),
    props: {
        value: {
            default: false
        },
        type: {
            default: ''
        },
        email: {
            default: ''
        },
        phone: {
            default() {
                return {
                    phone: '',
                    countryCode: 'IR'
                };
            }
        },
        requestUrl: {
            default: ''
        },
        verifyUrl: {
            default: ''
        }
    },
    data() {
        return {
            visible: this.value,
            code: '',
            requestingCode: false,
            verifyingCode: false,
            requestResult: {
                flag: 'None',       // 'None', 'NewCodeSent', 'TooManyRequests', 'CodeWasSentBefore', 'Error'
                remainingMs: 0
            },
            verifiyingCodeIsWrong: false,
            verifiyingError: ''
        };
    },
    methods: {
        getArgs() {
            var args = {};
            if (this.type === 'email') {
                args.email = this.email;
            } else {
                args.phoneNational = this.phone.phone;
                args.phoneCountryCode = this.phone.countryCode;
            }
            return args;
        },
        async requestCode() {
            try {
                this.requestingCode = true;
                var args = this.getArgs();
                var result = await this.$api.post(this.requestUrl, args);
                this.requestResult = Object.assign({}, this.requestResult, result);
                if (this.requestResult.flag !== 'None' && this.requestResult.flag !== 'Error') {
                    const variant = this.requestResult.flag === 'NewCodeSent' || this.requestResult.flag === 'CodeWasSentBefore' ?
                        'success' :
                        'danger';
                    const message = this.$t(this.requestResult.flag);
                    this.toastSuccess(message, undefined, variant);
                }
            } catch (error) {
                this.toastError(error);
                console.error(error);
                // close the window
                this.visible = false;
            } finally {
                this.requestingCode = false;
            }
        },
        async verifyCode() {
            try {
                this.verifyingCode = true;
                var args = this.getArgs();
                args.code = this.code;
                await this.$api.post(this.verifyUrl, args);
                this.reset();
                this.visible = false;
                this.$emit('done');
            } catch (error) {
                this.verifiyingCodeIsWrong = true;
                this.verifiyingError = error.join('<br/>');
            } finally {
                this.verifyingCode = false;
            }
        },
        reset() {
            this.code = '';
            this.requestingCode = false;
            this.verifyingCode = false;
            this.requestResult = {
                flag: 'None',
                remaingSeconds: 0
            };
            this.verifiyingCodeIsWrong = false;
            this.verifiyingError = '';
        }
    },
    computed: {
        title() {
            if (this.type === 'email') {
                return this.$t('verify-email-title');
            }
            return this.$t('verify-phone-title');
        },
        remainingTime() {
            return this.$t('remaining-time', [`${this.requestResult.remainingMs} ثانیه`]);
        },
        endDateMs() {
            return moment().valueOf() + this.requestResult.remainingMs;
        }
    },
    watch: {
        async value() {
            if (this.value !== this.visible) {
                this.visible = this.value;
            }
            if (this.value) {
                await this.requestCode();
            }
        },
        visible() {
            if (this.value !== this.visible) {
                this.$emit('input', this.visible);
            }
        }
    }
}
</script>