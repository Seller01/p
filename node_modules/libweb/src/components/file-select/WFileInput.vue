<template>
    <span>
        <span v-if="!supported">{{ $t('useChrome') }}</span>
        <span v-else>
            <center v-if="preview && showThumb">
                <img :src="thumbUrl"
                     :height="thumbHeight"
                     :style="{height: `${thumbHeight}px`}">
            </center>
            <input ref="fileInput"
                   type="file"
                   :name="inputName"
                   :id="inputIdentifier"
                   :accept="accept"
                   style="display: none;"
                   @change="onFilePicked">
            <label :for="labelId">{{ label }}</label>
            <div class="input-group">
                <input type="text"
                       class="form-control"
                       :id="labelId"
                       :placeholder="$t('select')"
                       :aria-label="$t('select')"
                       :aria-describedby="inputGroupId"
                       @click="pickFile"
                       v-model="fileName"
                       readonly
                       dir="ltr"
                       :disabled="disabled"
                       style="cursor: pointer"/>
                <div class="input-group-append" v-if="canDelete">
                    <button class="btn btn-danger"
                            type="button"
                            @click="deleteClicked">
                        &times;
                    </button>
                    <slot name="append"></slot>
                </div>
            </div>
        </span>
    </span>
</template>

<script>
import loc from "./WFileInput.i18n.json";
import {i18n} from "../../utility/VueI18n";
import {guid} from "../../utility/guid";
import {UrlParser} from '../../utility/url';
import {browserFileApiSupport} from "./browserFileApiSupport";
import {mimeHelper} from "../../utility/mimeHelper";
import {isString} from "./isString";
import {acceptToFileTypes} from "./acceptToFileTypes";

export default {
    i18n: i18n(loc),
    props: {
        label: {
            type: String,
            default: ""
        },
        value: {
            type: [String, File],
            default: ''
        },
        thumb: {
            type: String,
            default: ""
        },
        //max file size in kilo bytes
        maxSize: {
            type: Number,
            default: 1024 * 10
        },
        //file input accept
        //https://www.w3schools.com/tags/att_input_accept.asp
        //http://www.iana.org/assignments/media-types/
        accept: {
            type: String,
            default: "image/*"
        },
        preview: {
            type: Boolean,
            default: true
        },
        inputName: {
            type: String,
            default: "file"
        },
        inputId: {
            type: String,
            default: null
        },
        disabled: {
            type: Boolean,
            default: false
        },
        /**
         * متن خطای فایل با پسوند اشتباه
         */
        acceptError: {
            type: String,
            default: null
        },
        canDelete: {
            default: true
        }
    },
    data() {
        let iid = this.inputId;
        if (iid === undefined || iid === null) {
            iid = guid.newId();
        }
        return {
            urlParser: new UrlParser(),
            supported: browserFileApiSupport.supportsFileInput() && browserFileApiSupport.supportsFileApi(),
            showThumb: false,
            fileName: "",
            fileType: null,
            fileExtension: '',
            validFileTypes: [],
            thumbUrl: this.thumb,
            thumbHeight: 150,
            inputIdentifier: iid,
            labelId: guid.newId(),
            inputGroupId: guid.newId()
        };
    },
    mounted() {
        this.acceptChanged();
        this.valueChanged();
    },
    methods: {
        deleteClicked() {
            this.$emit('input', null);
            this.$emit('delete-click');
        },
        clear() {
            this.showThumb = false;
            this.fileName = null;
            this.fileType = '';
            this.fileExtension = '';
            this.thumbUrl = '';
            this.$refs.fileInput.value = null;
        },
        valueChanged() {
            if (this.value !== undefined && this.value !== null) {
                //create thumb
                if (isString(this.value)) {
                    if (this.value.length > 0) {
                        //url
                        const x = this.urlParser.parse(this.value).pathname;
                        this.fileName = x.substring(x.lastIndexOf('/') + 1);
                        this.fileType = mimeHelper.getMediaType(this.fileName);
                        this.fileExtension = mimeHelper.getExtension(this.fileType);
                        this.thumbUrl = mimeHelper.getIconPathForUrl(this.value, 64);
                        this.showThumb = true;
                        this.thumbHeight = 64;
                        this.$emit('thumbChange', this.thumbUrl);
                    }
                } else {
                    //file
                    this.fileName = this.value.name;
                    this.fileType = mimeHelper.getMediaType(this.fileName);
                    this.fileExtension = mimeHelper.getExtension(this.fileType);
                    mimeHelper.getIconPathForFile(this.value, x => {
                        this.showThumb = true;
                        this.thumbUrl = x.icon;
                        this.thumbHeight = 64;
                        this.$emit('thumbChange', this.thumbUrl);
                    }, 64);
                }
            } else {
                //clear
                this.clear();
            }
        },
        acceptChanged() {
            this.validFileTypes.splice(0, this.validFileTypes.length);
            const array = acceptToFileTypes(this.accept);
            array.forEach(a => {
                this.validFileTypes.push(a);
            });
        },
        checkMaxSize(fileSize) {
            if (fileSize > this.maxSize * 1024) {
                this.toast({
                    message: this.$t("maxSizeError", {maxSize: this.maxSize}),
                    variant: 'danger'
                })
                return false;
            }
            return true;
        },
        checkAccept(fileType) {
            if (this.validFileTypes.length === 0) {
                return true;
            }
            const type = fileType.toString().trim().toLowerCase();
            const index = this.validFileTypes.findIndex(a => {
                return (a.toString().trim().toLowerCase() === type);
            });
            if (index > -1) {
                return true;
            }
            let msg;
            if (this.acceptError === undefined || this.acceptError === null) {
                msg = this.$t("acceptError", {accept: this.accept});
            } else {
                msg = this.acceptError;
            }
            this.toast({
                message: msg,
                variant: 'danger'
            });
            return false;
        },
        set(file) {
            if (file !== undefined && file !== null) {
                //check if file has extension
                if (file.name.lastIndexOf(".") <= 0) {
                    return;
                }
                //check size
                if (!this.checkMaxSize(file.size)) {
                    return;
                }
                //check accept
                if (!this.checkAccept(file.type)) {
                    return;
                }
            }
            this.$emit('input', file);
        },
        pickFile() {
            if (this.disabled) {
                return;
            }
            this.$refs.fileInput.click();
        },
        onFilePicked(e) {
            const files = e.target.files || e.dataTransfer.files;
            //check if file is selected
            if (!files.length) {
                return;
            }
            const file = files[0];
            this.set(file);
            return false;
        }
    },
    watch: {
        accept() {
            this.acceptChanged();
        },
        value() {
            this.valueChanged();
        }
    },
};
</script>
