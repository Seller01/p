<template>
    <span>
        <b-modal v-model="visible" no-close-on-esc no-close-on-backdrop hide-footer size="xl" :title="title">
            <w-data-table-server :cols="postCols" @data-provider="loadPosts" v-show="canView" ref="table">
                <div slot="actions">
                    <b-button class="ml-1" variant="success" @click="startAdd" v-show="canAdd">{{$t('add-post')}}</b-button>
                </div>
                <span slot="id" slot-scope="{row, value}">{{value}}</span>
                <span slot="name" slot-scope="{row, value}">{{value}}</span>
                <span slot="publishFrom" slot-scope="{row, value}">{{value}}</span>
                <span
                    slot="publishUntilMs"
                    slot-scope="{row, value}"
                >{{row.hasPublishUntil ? dateHelper.formatUnixMs(value) : ''}}</span>
                <span slot="author" slot-scope="{row, value}">
                    <span :id="`author_${row.id}`">{{row.authorName}}</span>
                    <b-tooltip
                        :target="`author_${row.id}`"
                    >{{row.authorUserName}} - {{row.authorEmail}} - {{row.authorPhoneNumber}}</b-tooltip>
                </span>
                <span slot="lastEditor" slot-scope="{row, value}">
                    <span :id="`lastEditor_${row.id}`">{{row.lastEditorName}}</span>
                    <b-tooltip
                        :target="`lastEditor_${row.id}`"
                    >{{row.lastEditorUserName}} - {{row.lastEditorEmail}} - {{row.lastEditorPhoneNumber}}</b-tooltip>
                </span>
                <span slot="opr" slot-scope="{row, value}">
                    <b-button
                        class="ml-1 p-0"
                        size="sm"
                        variant="info"
                        v-show="canEdit"
                        :title="$t('edit')"
                        @click="startEdit(row)"
                    >
                        <w-mdi :size="18" value="pencil" />
                    </b-button>
                    <b-button
                        class="ml-1 p-0"
                        size="sm"
                        variant="link"
                        v-show="canEdit"
                        :title="$t('translations')"
                        @click="startEdit(row)"
                    >
                        <w-mdi :size="18" value="translate" />
                    </b-button>
                    <b-button
                        class="ml-1 p-0"
                        size="sm"
                        variant="danger"
                        v-show="canDelete"
                        :title="$t('delete')"
                        :disabled="row.removing"
                        @click="remove(row)"
                    >
                        <w-mdi :size="18" value="delete" />
                    </b-button>
                </span>
            </w-data-table-server>
        </b-modal>
        <b-modal
            v-model="modal.visible"
            :title="modal.title"
            no-close-on-esc
            no-close-on-backdrop
            hide-footer
            size="xl"
        >
            <b-tabs content-class="m-2 mt-3">
                <b-tab :title="$t('post-info')">
                    <b-form-group
                        :label="$t('name')"
                        :state="nameState"
                        :invalid-feedback="invalidName"
                        label-cols-lg="2"
                        label-cols-md="3"
                        label-align-md="right"
                    >
                        <b-form-input trim v-model="modal.item.name" />
                    </b-form-group>
                    <b-form-group :label="$t('publishFrom')" label-cols-lg="2" label-cols-md="3" label-align-md="right">
                        <w-date-picker v-model="modal.item.publishFromMs" />
                    </b-form-group>
                    <b-form-group label-cols-lg="2" label-cols-md="3" label-align-md="right">
                        <b-form-checkbox
                            v-model="modal.item.hasPublishUntil"
                        >{{modal.item.hasPublishUntil ? $t('publishUntilSpecificDate') : $t('publishForever')}}</b-form-checkbox>
                    </b-form-group>
                    <b-form-group
                        :label="$t('publishUntil')"
                        v-show="modal.item.hasPublishUntil"
                        label-cols-lg="2"
                        label-cols-md="3"
                        label-align-md="right"
                    >
                        <w-date-picker v-model="modal.item.publishUntilMs" />
                    </b-form-group>
                    <b-form-group :label="$t('description')" label-cols-lg="2" label-cols-md="3" label-align-md="right">
                        <b-form-textarea v-model="modal.item.description" :rows="3" :max-rows="6"></b-form-textarea>
                    </b-form-group>
                    <!-- اینو نمایش نده چون با ویراستار و مولف ترجمه ی پست قاطی می شه -->
                    <!-- <div class="row">
                        <div class="col-12 col-md-6">
                            <b-form-group :label="$t('lastEditor')"
                                          label-cols-lg="2"
                                          label-cols-md="3"
                                          label-align-md="right"
                                          v-show="!modal.isNew">
                                {{modal.item.lastEditorName}}<br />{{modal.item.lastEditorUserName}}<br />
                                {{modal.item.lastEditorEmail}}<br />{{modal.item.lastEditorPhoneNumber}}<br />
                                {{modal.item.updateDateTime}}
                            </b-form-group>
                        </div>
                        <div class="col-12 col-md-6 mt-md-2">
                            <b-form-group :label="$t('author')"
                                          label-cols-lg="2"
                                          label-cols-md="3"
                                          label-align-md="right"
                                          v-show="!modal.isNew">
                                {{modal.item.authorName}}<br />{{modal.item.authorUserName}}<br />
                                {{modal.item.authorEmail}}<br />{{modal.item.authorPhoneNumber}}<br />
                                {{modal.item.createDateTime}}
                            </b-form-group>
                        </div>
                    </div>-->
                    <b-button
                        class="mt-3"
                        block
                        variant="success"
                        :disabled="modal.saving || !nameState"
                        @click="save"
                    >{{$t('save')}}</b-button>
                </b-tab>
                <w-post-translations
                    ref="pt"
                    :value="modal.visible"
                    :post="modal.item"
                    :hide-content="modal.isNew"
                    :langs="getLangs()"
                />
            </b-tabs>
        </b-modal>
    </span>
</template>

<script>
import messages from './WPosts.i18n.json';
import { i18n } from "../../utility/VueI18n";
import { dateHelper } from "../../utility/dateHelper";
export default {
    i18n: i18n(messages),
    props: {
        value: {
            default: false
        },
        containerName: {
            default: ''
        },
        containerId: {
            default: ''
        },
        title: {
            default: ''
        },
        // array of {code, direction, name}
        langs: {
            default() {
                return [];
            }
        }
    },
    data() {
        return {
            dateHelper: dateHelper,
            visible: false,
            posts: [],
            postCols: [
                { header: this.$t('id'), field: 'id', visible: false, sortable: false },
                { header: this.$t('publishFrom'), field: 'publishFrom', sortField: 'publishFromMs', sortable: false },
                { header: this.$t('publishUntil'), field: 'publishUntilMs', sortField: 'publishUntilMs', sortable: false },
                { header: this.$t('name'), field: 'name', sortable: false },
                { header: this.$t('author'), field: 'author', sortable: false },
                { header: this.$t('lastEditor'), field: 'lastEditor', sortable: false },
                { header: this.$t('oprations'), field: 'opr', sortable: false },
            ],
            modal: {
                item: {},
                visible: false,
                title: '',
                isNew: false
            },
        };
    },
    methods: {
        getLangs() {
            return this.langs;
        },
        isEmpty(a) {
            return a === undefined || a === null || a.length === 0;
        },
        isVoid(a) {
            return a === undefined || a === null;
        },
        convert(a) {
            a.createDateTime = dateHelper.formatTicks(a.createUtc);
            a.updateDateTime = dateHelper.formatTicks(a.updateUtc);
            a.removing = false;
            a.publishFrom = dateHelper.formatUnixMs(a.publishFromMs);
            a.hasPublishUntil = !this.isVoid(a.publishUntilMs);
            if (this.isVoid(a.publishUntilMs)) {
                a.publishUntilMs = moment().valueOf();
            }
            return a;
        },
        empty() {
            var nowTicks = moment().valueOf() * 10000;
            var res = {
                id: '',
                createUtc: nowTicks,
                updateUtc: nowTicks,
                description: '',
                containerName: '',
                containerId: '',
                publishFromMs: moment().valueOf(),
                publishUntilMs: moment().add('years', 1).valueOf(),
                hasPublishUntil: true,
                authorId: '',
                lastEditorId: '',
                name: '',
                authorName: '',
                authorUserName: '',
                authorEmail: '',
                authorPhoneNumber: '',
                lastEditorName: '',
                lastEditorUserName: '',
                lastEditorEmail: '',
                lastEditorPhoneNumber: '',
            };
            return this.convert(res);
        },
        onShown() {
            setTimeout(() => {
                this.$refs.table.refresh();
            }, 1500);
        },
        onHidden() {
        },
        async loadPosts(args) {
            try {
                const { search, page, rowsPerPage, sorts, callback } = args;
                if (this.isEmpty(this.containerName) || this.isEmpty(this.containerId)) {
                    callback([], 0);
                    return;
                }
                var response = await this.$api.post('/api/blog/Post/ViewPosts', {
                    search,
                    page,
                    rowsPerPage,
                    sorts,
                    containerName: this.containerName,
                    containerId: this.containerId
                });
                callback(response.rows.map(a => this.convert(a)), response.totalRows);
            } catch (error) {
                this.toastError(error);
                console.error(error);
            }
        },
        startAdd() {
            this.modal.item = Object.assign({}, this.empty());
            this.modal.isNew = true;
            this.modal.title = this.$t('add-new-post');
            this.modal.visible = true;
            this.$nextTick(async () => {
                await this.$refs.pt.onShown();
            });
        },
        startEdit(item) {
            this.modal.item = Object.assign({}, item);
            this.modal.isNew = false;
            this.modal.title = this.$t('edit-post');
            this.modal.visible = true;
            this.$nextTick(async () => {
                await this.$refs.pt.onShown();
            });
        },
        async save() {
            var item = this.modal.item;
            try {
                this.modal.saving = true;
                var args = {
                    publishFromMs: item.publishFromMs,
                    publishUntilMs: item.hasPublishUntil ? item.publishUntilMs : null,
                    description: item.description,
                    name: item.name
                };
                if (this.modal.isNew) {
                    // add
                    args.containerName = this.containerName;
                    args.containerId = this.containerId;
                    var post = await this.$api.post('/api/blog/Post/AddPost', args);
                    this.$refs.table.addRow(this.convert(post));
                    // close the modal to let translations open next time on edit
                    this.modal.visible = false;
                } else {
                    // update
                    args.id = item.id;
                    var post = await this.$api.post('/api/blog/Post/UpdatePost', args);
                    var rows = this.$refs.table.getRows();
                    var i = rows.findIndex(a => a.id === item.id);
                    if (i > -1) {
                        this.$refs.table.updateRow(this.convert(post), i);
                    }
                }
                this.toastSuccess();
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.modal.saving = false;
            }
        },
        async remove(item) {
            if (await this.toastAsk()) {
                try {
                    item.removing = true;
                    await this.$api.post('/api/blog/Post/DeletePost', {
                        id: item.id
                    });
                    this.toastSuccess();
                    var rows = this.$refs.table.getRows();
                    var i = rows.findIndex(a => a.id === item.id);
                    if (i > -1) {
                        this.$refs.table.deleteRow(i);
                    }
                } catch (error) {
                    this.toastError(error);
                    console.error(error);
                } finally {
                    item.removing = false;
                }
            }
        }
    },
    computed: {
        canView() {
            return this.$user.hasAccess('blog_ViewPosts');
        },
        canAdd() {
            return this.$user.hasAccess('blog_AddPost');
        },
        canEdit() {
            return this.$user.hasAccess('blog_EditPost');
        },
        canDelete() {
            return this.$user.hasAccess('blog_DeletePost');
        },
        nameState() {
            return !this.isEmpty(this.modal.item.name);
        },
        invalidName() {
            if (this.nameState) {
                return '';
            }
            return this.$t('name-required');
        }
    },
    watch: {
        value() {
            if (this.value === this.visible) {
                return;
            }
            this.visible = this.value;
        },
        visible() {
            if (this.visible) {
                this.onShown();
            } else {
                this.onHidden();
            }
            if (this.value === this.visible) {
                return;
            }
            this.$emit('input', this.visible);
        }
    }
}
</script>