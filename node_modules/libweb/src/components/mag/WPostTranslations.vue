<template>
    <span v-show="ready">
        <b-tab v-for="a in translations" :key="a.culture">
            <span
                slot="title"
                v-show="!hideContent"
                :title="a.isNew ? '' : $t(a.verificationStatus)"
            >
                <b-spinner type="grow" small v-show="a.isNew"></b-spinner>
                <w-mdi
                    :value="getVerificationIcon(a)"
                    v-show="!a.isNew"
                    :style="{color: getVerificationColor(a)}"
                />
                <img :src="getCultureFlag(a.culture)" style="width: 24px; height: 24px;" />
                {{getCultureName(a.culture)}}
            </span>
            <span v-show="!hideContent">
                <b-form-group
                    :label="$t('title')"
                    :state="titleState(a)"
                    :invalid-feedback="invalidTitle(a)"
                    :description="$t('title-desc')"
                    label-cols-lg="2"
                    label-cols-md="3"
                    label-align-md="right"
                >
                    <b-form-input trim v-model="a.title" :dir="getCultureDirection(a.culture)" />
                </b-form-group>
                <b-form-group
                    :label="$t('excerpt')"
                    :state="excerptState(a)"
                    :invalid-feedback="invalidExcerpt(a)"
                    :description="$t('excerpt-desc')"
                    label-cols-lg="2"
                    label-cols-md="3"
                    label-align-md="right"
                >
                    <b-form-input trim v-model="a.excerpt" :dir="getCultureDirection(a.culture)" />
                </b-form-group>
                <b-form-group
                    :label="$t('slug')"
                    :description="$t('slug-desc')"
                    :state="slugState(a)"
                    :invalid-feedback="invalidSlug(a)"
                    label-cols-lg="2"
                    label-cols-md="3"
                    label-align-md="right"
                >
                    <b-input-group dir="ltr">
                        <b-input-group-prepend is-text>/</b-input-group-prepend>
                        <b-form-input trim v-model="a.slug" dir="ltr" />
                    </b-input-group>
                </b-form-group>
                <hr class="mt-5" />
                <b-form-group
                    :label="$t('content')"
                    class="mt-5"
                    style="position: relative"
                    label-cols-lg="2"
                    label-cols-md="3"
                    label-align-md="right"
                >
                    <w-block-editor :modules="modules" :value="a.content" :culture="a.culture"></w-block-editor>
                    <w-loading v-model="a.loadingContent"></w-loading>
                </b-form-group>
                <hr class="mt-5" />
                <b-form-group
                    :label="$t('meta-description')"
                    class="mt-5"
                    :description="$t('meta-description-desc')"
                    label-cols-lg="2"
                    label-cols-md="3"
                    label-align-md="right"
                >
                    <b-form-input
                        trim
                        v-model="a.metaDescription"
                        :dir="getCultureDirection(a.culture)"
                    />
                </b-form-group>
                <b-form-group
                    :label="$t('meta-keywords')"
                    :description="$t('meta-keywords-desc')"
                    label-cols-lg="2"
                    label-cols-md="3"
                    label-align-md="right"
                >
                    <b-form-input
                        trim
                        v-model="a.metaKeywords"
                        :dir="getCultureDirection(a.culture)"
                    />
                </b-form-group>
                <b-form-group
                    :label="$t('tags')"
                    :description="$t('tags-desc')"
                    label-cols-lg="2"
                    label-cols-md="3"
                    label-align-md="right"
                >
                    <b-form-tags
                        remove-on-delete
                        tag-variant="primary"
                        tag-pills
                        v-model="a.tagArray"
                        :placeholder="$t('tags')"
                    />
                </b-form-group>
                <b-form-group
                    :label="$t('thumbs')"
                    :description="$t('thumbs-desc')"
                    label-cols-lg="2"
                    label-cols-md="3"
                    label-align-md="right"
                >
                    <w-image-select v-model="a.thumbArray" />
                </b-form-group>
                <b-form-group
                    :label="$t('description')"
                    :description="$t('description-desc')"
                    label-cols-lg="2"
                    label-cols-md="3"
                    label-align-md="right"
                >
                    <b-form-textarea
                        v-model="a.description"
                        :rows="3"
                        :max-rows="6"
                        :dir="getCultureDirection(a.culture)"
                    />
                </b-form-group>
                <div class="row">
                    <div class="col-12 col-md-6">
                        <b-form-group
                            :label="$t('lastEditor')"
                            label-cols-lg="2"
                            label-cols-md="3"
                            label-align-md="right"
                        >
                            {{a.lastEditorName}}
                            <br />
                            {{a.lastEditorUserName}}
                            <br />
                            {{a.lastEditorEmail}}
                            <br />
                            {{a.lastEditorPhoneNumber}}
                            <br />
                            {{a.updateDateTime}}
                        </b-form-group>
                    </div>
                    <div class="col-12 col-md-6 mt-md-2">
                        <b-form-group
                            :label="$t('author')"
                            label-cols-lg="2"
                            label-cols-md="3"
                            label-align-md="right"
                        >
                            {{a.authorName}}
                            <br />
                            {{a.authorUserName}}
                            <br />
                            {{a.authorEmail}}
                            <br />
                            {{a.authorPhoneNumber}}
                            <br />
                            {{a.createDateTime}}
                        </b-form-group>
                    </div>
                </div>
                <b-button
                    variant="success"
                    class="mt-3"
                    block
                    @click="save(a)"
                    :disabled="a.saving || !canTranslate || !titleState(a) || !excerptState(a) || !slugState(a)"
                >{{$t('save')}}</b-button>
                <hr class="mt-5" v-show="canVerify && !a.isNew" />
                <div class="row" v-show="!a.isNew">
                    <div class="col-12 col-md-6">
                        <b-form-group
                            :label="$t('verification')"
                            label-cols-lg="2"
                            label-cols-md="3"
                            label-align-md="right"
                        >
                            {{a.verifierName}}
                            <br />
                            {{a.verifierUserName}}
                            <br />
                            {{a.verifierEmail}}
                            <br />
                            {{a.verifierPhoneNumber}}
                            <br />
                            {{getVerificationDate(a)}}
                        </b-form-group>
                    </div>
                    <div class="col-12 col-md-6 mt-md-2" v-show="canVerify">
                        <b-form-group
                            :label="$t('verification-status')"
                            label-cols-lg="2"
                            label-cols-md="3"
                            label-align-md="right"
                        >
                            <b-form-select
                                v-model="a.verificationStatus"
                                :options="verificationStatuses"
                            />
                        </b-form-group>
                        <b-form-group
                            :label="$t('verification-message')"
                            label-cols-lg="2"
                            label-cols-md="3"
                            label-align-md="right"
                        >
                            <b-form-textarea
                                :rows="3"
                                :max-rows="6"
                                v-model="a.verificationMessage"
                            ></b-form-textarea>
                        </b-form-group>
                        <b-button
                            variant="success"
                            class="mt-3"
                            block
                            @click="verify(a)"
                            :disabled="!canVerify"
                        >{{$t('save')}}</b-button>
                    </div>
                </div>
            </span>
        </b-tab>
    </span>
</template>

<script>
import messages from './WPostTranslations.i18n.json';
import { i18n } from "../../utility/VueI18n";
import { ServerValues } from "../../utility/ServerValues";
import { dateHelper } from "../../utility/dateHelper";
import { UrlParser } from '../../utility/url';
export default {
    i18n: i18n(messages),
    props: {
        value: {
            default: false
        },
        post: {
            default() {
                return {};
            }
        },
        hideContent: {
            default: false
        },
        // array of {code, direction, name}
        langs: {
            default() {
                return [];
            }
        }
    },
    data() {
        const sv = new ServerValues().getValues();
        return {
            cultures: sv['cultures'],
            translations: [],
            ready: false,
            modules: [
                { type: 'text' },
                { type: 'paragraph' },
                { type: 'header' },
                { type: 'delimiter' },
                { type: 'aparat' },
                { type: 'image-url' },
                { type: 'images-url' },
                { type: 'raw-html' },
                { type: 'youtube' },
            ],
            verificationStatuses: [
                { text: this.$t('not-set'), value: 'not-set' },
                { text: this.$t('rejected'), value: 'rejected' },
                { text: this.$t('confirmed'), value: 'confirmed' },
            ]
        };
    },
    methods: {
        getCultureFlag(culture) {
            return `/culture-flags/${culture.toUpperCase()}.svg`;
        },
        getCultureName(culture) {
            const i = this.langs.findIndex(a => a.code === culture);
            if (i > -1) {
                return this.langs[i].name;
            }
            return 'Unknown';
        },
        getCultureDirection(culture) {
            const i = this.langs.findIndex(a => a.code === culture);
            if (i > -1) {
                return this.langs[i].direction;
            }
            return 'ltr';
        },
        isEmpty(a) {
            return a === undefined || a === null || a.length === 0;
        },
        isVoid(a) {
            return a === undefined || a === null;
        },
        convert(a) {
            a.createDateTime = dateHelper.formatTicks(a.createUtc);
            a.updateDateTime = dateHelper.formatTicks(a.updateUtc);
            a.saving = false;
            a.verifying = false;
            a.isNew = this.isEmpty(a.id);
            a.thumbArray = this.isEmpty(a.thumbs) ? [] : a.thumbs.split('|');
            a.tagArray = this.isEmpty(a.tags) ? [] : a.tags.split('|');
            a.content = {
                blocks: []
            };
            a.loadingContent = false;
            return a;
        },
        empty() {
            const nowTicks = moment().valueOf() * 10000;
            const res = {
                id: '',
                createUtc: nowTicks,
                updateUtc: nowTicks,
                description: '',
                postId: '',
                culture: '',
                title: '',
                excerpt: '',
                thumbs: '',
                contentId: '',
                slug: '',
                metaDescription: '',
                metaKeywords: '',
                tags: '',
                authorId: '',
                lastEditorId: '',
                verifiedBy: null,
                verificationMs: null,
                verificationStatus: 'not-set',
                verificationMessage: '',
                contentUrl: '',
                // author props
                authorName: '',
                authorUserName: '',
                authorEmail: '',
                authorPhoneNumber: '',
                // editor props
                lastEditorName: '',
                lastEditorUserName: '',
                lastEditorEmail: '',
                lastEditorPhoneNumber: '',
                // verifier props (can be null)
                verifierName: '',
                verifierUserName: '',
                verifierEmail: '',
                verifierPhoneNumber: '',
            };
            return this.convert(res);
        },
        async onShown() {
            try {
                this.ready = false;
                this.translations.splice(0, this.translations.length);
                const urlParser = new UrlParser();
                const url = urlParser.parse('/api/blog/Post/ViewPostTranslations');
                url.query.postId = this.post.id;
                const list = await this.$api.get(url.toRelative());
                this.cultures.forEach(culture => {
                    const found = list.find(a => a.culture === culture);
                    if (this.isVoid(found)) {
                        var f = this.empty();
                        f.postId = this.post.id;
                        f.culture = culture;
                        this.translations.push(f);
                    } else {
                        var f = this.convert(found);
                        this.translations.push(f);
                        this.loadContent(f);
                    }
                });
                this.ready = true;
            } catch (error) {
                this.toastError(error);
                console.error(error);
            }
        },
        loadContent(item) {
            try {
                item.loadingContent = true;
                $.get(item.contentUrl, data => {
                    item.content = data;
                });
                item.loadingContent = false;
            } catch (error) {
                console.error(error);
            }
        },
        onHidden() {
            this.translations.splice(0, this.translations.length);
        },
        async save(item) {
            try {
                item.saving = true;
                const args = {
                    postId: item.postId,
                    culture: item.culture,
                    title: item.title,
                    excerpt: item.excerpt,
                    thumbs: item.thumbArray,
                    content: JSON.stringify(item.content),
                    slug: item.slug,
                    metaDescription: item.metaDescription,
                    metaKeywords: item.metaKeywords,
                    tags: item.tagArray,
                    description: item.description
                };
                const trans = await this.$api.post('/api/blog/Post/TranslatePost', args);
                this.toastSuccess();
                const i = this.translations.findIndex(a => a.culture === item.culture);
                if (i > -1) {
                    const f = this.convert(trans);
                    this.$set(this.translations, i, f);
                    this.loadContent(f);
                }
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                item.saving = false;
            }
        },
        titleState(item) {
            return !this.isEmpty(item.title);
        },
        invalidTitle(item) {
            if (this.titleState(item)) {
                return '';
            }
            return this.$t('title-required');
        },
        excerptState(item) {
            return !this.isEmpty(item.excerpt);
        },
        invalidExcerpt(item) {
            return this.excerptState(item) ? '' : this.$t('excerpt-required');
        },
        slugState(item) {
            return !this.isEmpty(item.slug);
        },
        invalidSlug(item) {
            return this.slugState(item) ? '' : this.$t('slug-required');
        },
        getVerificationIcon(item) {
            const s = item.verificationStatus;
            if (s === 'not-set') {
                return 'exclamation-thick';
            }
            if (s === 'confirmed') {
                return 'check';
            }
            if (s === 'rejected') {
                return 'close';
            }
            return '';
        },
        getVerificationColor(item) {
            const s = item.verificationStatus;
            if (s === 'not-set') {
                return 'orange';
            }
            if (s === 'confirmed') {
                return 'green';
            }
            if (s === 'rejected') {
                return 'red';
            }
            return '';
        },
        getVerificationDate(item) {
            if (this.isVoid(item.verificationMs)) {
                return '';
            }
            return dateHelper.formatUnixMs(item.verificationMs);
        },
        async verify(item) {
            try {
                item.verifying = true;
                const args = {
                    id: item.id,
                    verificationStatus: item.verificationStatus,
                    verificationMessage: item.verificationMessage
                };
                const trans = await this.$api.post('/api/blog/Post/VerifyPostTranslation', args);
                this.toastSuccess();
                const i = this.translations.findIndex(a => a.culture === item.culture);
                if (i > -1) {
                    const f = this.convert(trans);
                    this.$set(this.translations, i, f);
                    this.loadContent(f);
                }
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                item.verifying = false;
            }
        }
    },
    computed: {
        canTranslate() {
            return this.$user.hasAccess('blog_TranslatePosts');
        },
        canVerify() {
            return this.$user.hasAccess('blog_VerifyPosts');
        }
    },
    watch: {
        async value() {
            if (!this.value) {
                this.onHidden();
            } else {
                await this.onShown();
            }
        }
    }
}
</script>