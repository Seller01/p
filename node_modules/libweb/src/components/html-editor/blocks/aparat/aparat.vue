<template>
    <div class="w-100">
        <div v-html="data.html"></div>
        <div class="form-group">
            <label>{{$t('html')}}</label>
            <textarea class="form-control" readonly v-model="data.html" dir="ltr" style="direction:ltr"></textarea>
        </div>
        <div class="form-group">
            <div class="btn-group">
                <button class="btn btn-secondary" :class="btnCopyCls" :title="$t('copy')">
                    <span class="mdi mdi-18px mdi-content-copy"></span>
                </button>
                <button class="btn btn-primary ml-2" :title="$t('enter-embed-html')" @click="modal.visible = true">
                    <span class="mdi mdi-18px mdi-video-vintage"></span>
                </button>
            </div>
        </div>
        <div class="form-group">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text" :style="{ width: '150px' }">{{$t('caption')}}</span>
                </div>
                <input :placeholder="$t('caption')" class="form-control" v-model="data.caption" />
            </div>
        </div>
        <b-modal v-model="modal.visible" :title="$t('enter-embed-html')" hide-footer size="md">
            <div class="form-group">
                <textarea class="form-control" v-model="modal.embedHtml" dir="ltr" rows="6" style="direction: ltr"></textarea>
            </div>
            <div class="form-group">
                <button class="button btn-block btn-primary" @click="importEmbedHtml">{{$t('import')}}</button>
            </div>
        </b-modal>
    </div>
</template>

<script>
import loc from './aparat.i18n.json';
import Aparat from './Aparat';
import Clipboard from 'clipboard';
import { i18n } from "../../../../utility/VueI18n";
import { guid } from "../../../../utility/guid";
const d = new Aparat();
export default {
    i18n: i18n(loc),
    props: {
        /**
         * object of type {
         *  url: '',
         *  caption: '',
         *  fullWidth: true
         * }
         */
        value: {
            type: Object,
            default() {
                return d.getEmptyData();
            }
        },
        /**
         * object of type { }
         */
        config: {
            type: Object,
            default() {
                return d.getEmptyConfig();
            }
        }
    },
    data() {
        return {
            data: Object.assign({}, this.value),
            collapseId: guid.newId(),
            modal: {
                visible: false,
                embedHtml: '',
            },
            defaultSettings: {
                width: "560px",
                height: "320px"
            },
            settings: {
                width: "560px",
                height: "320px"
            },
            btnCopyCls: guid.newId(),
            clipboard: null,
        };
    },
    created() {
        this.clipboard = new Clipboard(`.${this.btnCopyCls}`, {
            text: trigger => {
                var res = this.data.html;
                this.toast({
                    variant: 'info',
                    message: this.$t('copied'),
                    delay: 1000
                });
                return res;
            }
        });
        this.dataChanged();
    },
    methods: {
        getData() {
            return Object.assign({}, d.getEmptyData(), this.data);
        },
        setData(o) {
            this.data = Object.assign({}, d.getEmptyData(), o);
        },
        getJq(html) {
            return $(html);
        },
        getFrame(jq) {
            return jq.find('iframe');
        },
        dataChanged() {
            if (!_.isNil(this.data.html)) {
                const jq = this.getFrame(this.getJq(this.data.html));
                jq.css('max-width', '100%');
                const w = jq.css('width');
                const h = jq.css('height');
                this.settings.width = _.isNil(w) ? this.settings.width : w;
                this.settings.height = _.isNil(h) ? this.settings.height : h;
            }
            if (!_.isEqual(this.data, this.value)) {
                this.$emit('input', this.getData());
            }
        },
        settingsChanged() {
            if (_.isNil(this.data.html)) {
                return;
            }
            const jq = this.getJq(this.data.html);
            const frame = this.getFrame(jq);
            if (!_.isNil(this.settings.width)) {
                frame.css('width', this.settings.width);
            }
            if (!_.isNil(this.settings.height)) {
                frame.css('height', this.settings.height);
            }
            frame.css('max-width', '100%');
            this.data.html = this.outerHTML(jq);
        },
        importEmbedHtml() {
            function showErrorMessage() {
                this.toastError(this.$t('error-importing-embed-html'));
            }
            var showErr = showErrorMessage.bind(this);
            try {
                var html = this.modal.embedHtml;
                const jq = this.getJq(html);
                const frame = this.getFrame(jq);
                frame.css('width', this.defaultSettings.width);
                frame.css('height', this.defaultSettings.height);
                frame.removeAttr('width').removeAttr('height');
                frame.css('max-width', '100%');
                this.data.html = this.outerHTML(frame);
                this.modal.visible = false;
            } catch (e) {
                console.log(e);
                showErr();
            }
        },
        outerHTML(jq) {
            return jq[0].outerHTML;
        }
    },
    watch: {
        value: {
            handler() {
                if (!_.isEqual(this.data, this.value)) {
                    this.setData(this.value);
                }
            },
            deep: true
        },
        data: {
            handler() {
                this.dataChanged();
            },
            deep: true
        },
        settings: {
            handler() {
                this.settingsChanged();
            },
            deep: true
        }
    }
}
</script>