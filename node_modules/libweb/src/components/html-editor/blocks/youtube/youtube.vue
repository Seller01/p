<template>
    <div class="w-100">
        <div v-html="data.html"></div>
        <div class="form-group">
            <label>{{$t('html')}}</label>
            <textarea class="form-control" readonly v-model="data.html" dir="ltr" style="direction:ltr"></textarea>
        </div>
        <div class="form-group">
            <div class="btn-group">
                <button class="btn btn-secondary" :class="btnCopyCls" :title="$t('copy')">
                    <span class="mdi mdi-18px mdi-content-copy"></span>
                </button>
                <button class="btn btn-primary ml-2" :title="$t('enter-embed-html')" @click="modal.visible = true">
                    <span class="mdi mdi-18px mdi-youtube"></span>
                </button>
            </div>
        </div>
        <div class="form-group">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text" :style="{ width: '150px' }">{{$t('caption')}}</span>
                </div>
                <input class="form-control" v-model="data.caption" />
            </div>
        </div>
        <div class="form-group">
            <button class="btn btn-primary" @click="settingsVisible = !settingsVisible">
                <span class="mdi mdi-18px" :class="[settingsVisible ? 'mdi-menu-down' : 'mdi-menu-up']"></span>
                &nbsp; {{$t('settings')}}
            </button>
            <div v-show="settingsVisible">
                <div class="card card-body">
                    <youtube-settings v-model="settings"></youtube-settings>
                </div>
            </div>
        </div>
        <b-modal v-model="modal.visible" :title="$t('enter-embed-html')" hide-footer size="md">
            <div class="form-group">
                <textarea class="form-control" v-model="modal.embedHtml" dir="ltr" rows="6" style="direction: ltr"></textarea>
            </div>
            <div class="form-group">
                <button class="btn btn-primary btn-block" @click="importEmbedHtml">{{$t('import')}}</button>
            </div>
        </b-modal>
    </div>
</template>

<script>
import loc from './youtube.i18n.json';
import Youtube from './Youtube';
import youtubeSettings from './youtube-settings.vue';
import Clipboard from 'clipboard';
import { i18n } from "../../../../utility/VueI18n";
import { guid } from "../../../../utility/guid";
const d = new Youtube();
export default {
    i18n: i18n(loc),
    components: {
        'youtube-settings': youtubeSettings
    },
    props: {
        /**
         * object of type {
         *  html: '',
         *  caption: '',
         * }
         */
        value: {
            type: Object,
            default() {
                return d.getEmptyData();
            }
        },
        /**
         * object of type { }
         */
        config: {
            type: Object,
            default() {
                return d.getEmptyConfig();
            }
        }
    },
    data() {
        return {
            data: Object.assign({}, this.value),
            settingsVisible: false,
            modal: {
                visible: false,
                embedHtml: '',
            },
            settings: {
                width: "560px",
                height: "320px"
            },
            btnCopyCls: guid.newId(),
            clipboard: null,
        };
    },
    created() {
        this.clipboard = new Clipboard(`.${this.btnCopyCls}`, {
            text: trigger => {
                var res = this.data.html;
                this.toast({
                    variant: 'info',
                    message: this.$t('copied'),
                    delay: 1000
                });
                return res;
            }
        });
        this.dataChanged();
        // $(() => {
        //     setTimeout(() => {
        //         this.modal.visible = true;
        //     }, 500);
        // });
    },
    methods: {
        getData() {
            return Object.assign({}, d.getEmptyData(), this.data);
        },
        setData(o) {
            this.data = Object.assign({}, d.getEmptyData(), o);
        },
        dataChanged() {
            if (!_.isNil(this.data.html)) {
                const jq = $(this.data.html);
                const w = jq.css('width');
                const h = jq.css('height');
                this.settings.width = _.isNil(w) ? this.settings.width : w;
                this.settings.height = _.isNil(h) ? this.settings.height : h;
            }
            if (!_.isEqual(this.data, this.value)) {
                this.$emit('input', this.getData());
            }
        },
        settingsChanged() {
            if (_.isNil(this.data.html)) {
                return;
            }
            const jq = $(this.data.html);
            if (!_.isNil(this.settings.width)) {
                jq.css('width', this.settings.width);
            }
            if (!_.isNil(this.settings.height)) {
                jq.css('height', this.settings.height);
            }
            this.data.html = jq[0].outerHTML;
        },
        importEmbedHtml() {
            function showErrorMessage() {
                this.toastError(this.$t('error-importing-embed-html'));
            }
            var showErr = showErrorMessage.bind(this);
            try {
                var html = this.modal.embedHtml;
                const jq = $(html);
                jq.css('width', `${jq.attr('width')}px`);
                jq.css('height', `${jq.attr('height')}px`);
                jq.removeAttr('width').removeAttr('height');
                this.data.html = jq[0].outerHTML;
                this.modal.visible = false;
            } catch (e) {
                console.log(e);
                showErr();
            }
        }
    },
    watch: {
        value: {
            handler() {
                if (!_.isEqual(this.data, this.value)) {
                    this.setData(this.value);
                }
            },
            deep: true
        },
        data: {
            handler() {
                this.dataChanged();
            },
            deep: true
        },
        settings: {
            handler() {
                this.settingsChanged();
            },
            deep: true
        }
    }
}
</script>