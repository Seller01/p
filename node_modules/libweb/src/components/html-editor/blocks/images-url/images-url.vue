<template>
    <div class="w-100">
        <w-filer-modal v-model="choosing" @selected="imageSelected"></w-filer-modal>
        <w-filer-modal v-model="choosingMany" @selected="imagesSelected"></w-filer-modal>
        <w-dragger :list="data.images" :can-delete="true" :group="dragGroup" @delete="onDelete">
            <div class="w-100" slot-scope="{item}">
                <div class="row">
                    <div class="col-12">
                        <div class="card card-body" style="width: 250px;">
                            <img style="object-fit: cover;height: 150px;" :src="getImageUrl(item.url, 80, null, 150)" />
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card card-body">
                            <h6 class="card-title">{{$t('caption')}}</h6>
                            <div class="card-text">
                                <vue-trix v-model="item.caption"></vue-trix>
                                <!-- <w-medium-editor v-model="item.caption" :buttons="buttons"></w-medium-editor> -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-100">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <button
                                :title="$t('select-image')"
                                class="btn btn-primary"
                                :style="{width: '50px'}"
                                @click="changeImage(item)"
                            >
                                <span class="mdi mdi-18px mdi-folder-image"></span>
                            </button>
                        </div>
                        <input
                            v-model="item.url"
                            class="form-control"
                            :placeholder="$t('url')"
                            dir="ltr"
                            style="direction: left"
                        />
                    </div>
                </div>
            </div>
        </w-dragger>
        <div class="form-group mt-2">
            <label>{{$t('type')}}</label>
            <select v-model="data.type" class="form-control">
                <option v-for="t in types" :key="t.value" :value="t.value">{{t.name}}</option>
            </select>
        </div>
        <div class="btn-group mt-2" role="group">
            <button class="btn btn-success mx-md-2 btn-sm" @click="addOne">
                <span class="mdi mdi-18px mdi-plus"></span>
                &nbsp;{{$t('add-one-image')}}
            </button>
            <button class="btn btn-success mx-md-2 btn-sm" @click="choosingMany = true">
                <span class="mdi mdi-18px mdi-plus"></span>
                &nbsp;{{$t('add-many-images')}}
            </button>
            <button class="btn btn-danger mx-md-2 btn-sm" @click="onDeleteAll">
                <span class="mdi mdi-18px mdi-close"></span>
                &nbsp;{{$t('deleteAll')}}
            </button>
        </div>
    </div>
</template>

<script>
import loc from './images-url.i18n.json';
import ImagesUrl from './ImagesUrl';
import { i18n } from "../../../../utility/VueI18n";
import { guid } from "../../../../utility/guid";
import { thumber } from "../../../../utility/thumber";
const d = new ImagesUrl();
export default {
    i18n: i18n(loc),
    props: {
        /**
         * type: 'gallery',        //carousel, slider
         * images: [],             //array of {url, caption}
         */
        value: {
            type: Object,
            default() {
                return d.getEmptyData();
            }
        },
        /**
         * validExtensions: ['jpg', 'jpeg', 'gif', 'png', 'svg']
         * validTypes: ['gallery', 'carousel', 'slider']
         */
        config: {
            type: Object,
            default() {
                return d.getEmptyConfig();
            }
        }
    },
    data() {
        return {
            data: d.getEmptyData(),
            choosing: false,
            choosingImage: null,
            choosingMany: false,
            buttons: [
                'bold',
                'italic',
                'underline',
                'strikethrough',
                'subscript',
                'superscript',
                'anchor',
                'quote',
                'pre',
                'orderedlist',
                'unorderedlist',
                'removeFormat',
                'highlight',
                'h1',
                'h2',
                'h3',
            ],
            dragGroup: guid.newId(),
        };
    },
    created() {
        this.setData(this.value);
    },
    methods: {
        getImageUrl(imagePath, quality = 90, width = null, height = null) {
            return thumber.relative(imagePath, quality, width, height);
        },
        getData() {
            return this.data;
        },
        setData(o) {
            if (!_.isNil(o)) {
                this.data.type = o.type;
                this.data.images.splice(0, this.data.images.length);
                o.images.forEach(img => {
                    this.data.images.push({
                        url: img.url,
                        caption: img.caption
                    });
                });
            }
        },
        changeImage(img) {
            this.choosingImage = img;
            this.choosing = true;
        },
        imageSelected(items) {
            var img = this.choosingImage;
            if (_.isNil(img)) {
                return;
            }
            this.choosingImage = null;
            function showError(err) {
                this.toastError(_.isNil(err) ? this.$t('select-only-one-image') : err);
            }
            if (_.isNil(items) || items.length > 1) {
                return showError.bind(this)();
            }
            var x = items[0];
            if (x.type !== 'file') {
                return showError.bind(this)();
            }
            var validExtensions = this.config.validExtensions;
            var ext = x.extension;
            var i = validExtensions.findIndex(e => e === ext);
            if (i < 0) {
                return showError.bind(this)(this.$t('validExtensions',
                    [JSON.stringify(validExtensions)]));
            }
            this.choosing = false;
            img.url = x.url;
        },
        addOne() {
            this.data.images.push({
                url: '',
                caption: ''
            });
        },
        imagesSelected(items) {
            function showError(err) {
                this.toastError(_.isNil(err) ? this.$t('select-only-image') : err);
            }
            if (_.isNil(items) || items.length === 0) {
                return showError.bind(this)();
            }
            var i = items.findIndex(a => a.type !== 'file');
            if (i > -1) {
                return showError.bind(this)();
            }
            var validExtensions = this.config.validExtensions;
            i = items.findIndex(a => {
                var j = validExtensions.findIndex(e => e === a.extension);
                return j < 0;
            });
            if (i > -1) {
                return showError.bind(this)(this.$t('validExtensions',
                    [JSON.stringify(validExtensions)]));
            }
            this.choosingMany = false;
            var urls = items.map(a => a.url);
            urls.forEach(url => {
                this.data.images.push({
                    url: url,
                    caption: ''
                });
            });
        },
        async onDelete(args) {
            const { item, index } = args;
            args.cancel = true;
            if (await this.toastAsk()) {
                this.data.images.splice(index, 1);
            }
        },
        async onDeleteAll() {
            if (await this.toastAsk()) {
                this.data.images.splice(0, this.data.images.length);
            }
        },
    },
    computed: {
        types() {
            var all = [
                {
                    value: 'unknown',
                    name: this.$t('unknown'),
                },
                {
                    value: 'gallery',
                    name: this.$t('gallery'),
                },
                {
                    value: 'carousel',
                    name: this.$t('carousel'),
                },
                {
                    value: 'slider',
                    name: this.$t('slider'),
                },
            ];
            var validTypes = this.config.validTypes;
            return all.filter(a => {
                var i = validTypes.findIndex(t => t === a.value);
                return i > -1;
            });
        }
    },
    watch: {
        value: {
            handler() {
                if (!_.isEqual(this.data, this.value)) {
                    this.setData(this.value);
                }
            },
            deep: true
        },
        data: {
            handler() {
                setTimeout(() => {
                    if (!_.isEqual(this.data, this.value)) {
                        this.$emit('input', this.data);
                    }
                }, 400);
            },
            deep: true
        }
    }
}
</script>