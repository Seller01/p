<template>
    <b-card :title="$t('title')">
        <div class="row">
            <div class="col-12 col-md-6">
                <b-card>
                    <b-form-group
                        :label="$t('verification-code-email-sender')"
                        label-for="verification-code-email-sender"
                    >
                        <b-input-group>
                            <template v-slot:prepend>
                                <b-button
                                    variant="danger"
                                    size="sm"
                                    @click="() => o.verificationCodeEmailSenderId = null"
                                >X</b-button>
                            </template>
                            <b-form-select
                                id="verification-code-email-sender"
                                v-model="o.verificationCodeEmailSenderId"
                                :options="emailSenders"
                                text-field="name"
                                value-field="id"
                            />
                        </b-input-group>
                        <b-button
                            class="mt-3"
                            variant="success"
                            block
                            @click="setVerificationCodeEmailSender"
                            :disabled="settingVerificationCodeEmailSender"
                            v-show="canSetVerificationCodeEmailSender"
                        >{{$t('save')}}</b-button>
                    </b-form-group>
                </b-card>
            </div>
            <div class="col-12 col-md-6 mt-3 mt-md-0">
                <b-card>
                    <b-form-group :label="$t('verification-code-sms-sender')" label-for="verification-code-sms-sender">
                        <b-input-group>
                            <template v-slot:prepend>
                                <b-button
                                    size="sm"
                                    variant="danger"
                                    @click="() => o.verificationCodeSmsSenderId = null"
                                >X</b-button>
                            </template>
                            <b-form-select
                                id="verification-code-sms-sender"
                                v-model="o.verificationCodeSmsSenderId"
                                :options="smsSenders"
                                text-field="name"
                                value-field="id"
                            />
                        </b-input-group>
                        <b-button
                            class="mt-3"
                            variant="success"
                            block
                            @click="setVerificationCodeSmsSender"
                            :disabled="settingVerificationCodeSmsSender"
                            v-show="canSetVerificationCodeSmsSender"
                        >{{$t('save')}}</b-button>
                    </b-form-group>
                </b-card>
            </div>
            <div class="col-12 mt-3">
                <b-card>
                    <p dir="ltr" v-if="debug">{{o.emailSubject}}</p>
                    <b-form-group
                        :label="$t('verification-code-email-subject')"
                        :description="$t('code-placeholder-help')"
                    >
                        <w-txt-translator v-model="o.emailSubject" :modules="[{type: 'text'}]" :langs="getLangs()"></w-txt-translator>
                    </b-form-group>
                    <b-button
                        class="mt-3"
                        variant="success"
                        block
                        @click="setVerificationCodeEmailSubject"
                        :disabled="settingVerificationCodeEmailSubject"
                        v-show="canSetVerificationCodeEmailContent"
                    >{{$t('save')}}</b-button>
                </b-card>
            </div>
            <div class="col-12 mt-3">
                <b-card>
                    <p dir="ltr" v-if="debug">{{o.emailBody}}</p>
                    <b-form-group
                        :label="$t('verification-code-email-body')"
                        :description="$t('code-placeholder-help')"
                    >
                        <w-txt-translator
                            v-model="o.emailBody"
                            :modules="[{type: 'raw-html'}]"
                            :text-to-block="text => { return { type: 'raw-html', data: { text: text } }; }"
                            :langs="getLangs()"
                        ></w-txt-translator>
                    </b-form-group>
                    <b-button
                        class="mt-3"
                        variant="success"
                        block
                        @click="setVerificationCodeEmailBody"
                        :disabled="settingVerificationCodeEmailBody"
                        v-show="canSetVerificationCodeEmailContent"
                    >{{$t('save')}}</b-button>
                </b-card>
            </div>
            <div class="col-12 mt-3">
                <b-card>
                    <p dir="ltr" v-if="debug">{{o.sms}}</p>
                    <b-form-group :label="$t('verification-code-sms')" :description="$t('code-placeholder-help')">
                        <w-txt-translator v-model="o.sms" :modules="[{type: 'text'}]" :langs="getLangs()"></w-txt-translator>
                    </b-form-group>
                    <b-button
                        class="mt-3"
                        variant="success"
                        block
                        @click="setVerificationCodeSms"
                        :disabled="settingVerificationCodeSms"
                        v-show="canSetVerificationCodeSmsContent"
                    >{{$t('save')}}</b-button>
                </b-card>
            </div>
        </div>
    </b-card>
</template>

<script>
import loc from './Auth.i18n.json';
import { i18n } from "../../utility/VueI18n";
export default {
    i18n: i18n(loc),
    props: {
        langs: {
            default() {
                return [];
            }
        }
    },
    data() {
        return {
            debug: false,
            o: {
                verificationCodeEmailSenderId: null,
                verificationCodeSmsSenderId: null,
                verificationCodeEmailSubjectId: '',
                verificationCodeEmailBodyId: '',
                verificationCodeSmsId: '',
                // array of { content, culture }
                emailSubject: [],
                // array of { content, culture }
                emailBody: [],
                // array of { content, culture }
                sms: []
            },
            // array of { id, name }
            emailSenders: [],
            // array of { id, name }
            smsSenders: [],
            settingVerificationCodeEmailSender: false,
            settingVerificationCodeSmsSender: false,
            settingVerificationCodeEmailSubject: false,
            settingVerificationCodeEmailBody: false,
            settingVerificationCodeSms: false,
        };
    },
    async mounted() {
        try {
            var data = await this.$api.get('/api/usermanager/UserManager/GetConfig');
            this.o.verificationCodeEmailSenderId = data.verificationCodeEmailSenderId;
            this.o.verificationCodeSmsSenderId = data.verificationCodeSmsSenderId;
            this.o.verificationCodeEmailSubjectId = data.verificationCodeEmailSubjectId;
            this.o.verificationCodeEmailBodyId = data.verificationCodeEmailBodyId;
            this.o.verificationCodeSmsId = data.verificationCodeSmsId;
            this.o.emailSubject.splice(0, this.o.emailSubject.length);
            data.emailSubject.forEach(a => {
                this.o.emailSubject.push({
                    content: a.content,
                    culture: a.culture
                });
            });
            this.o.emailBody.splice(0, this.o.emailBody.length);
            data.emailBody.forEach(a => {
                this.o.emailBody.push({
                    content: a.content,
                    culture: a.culture
                });
            });
            this.o.sms.splice(0, this.o.sms.length);
            data.sms.forEach(a => {
                this.o.sms.push({
                    content: a.content,
                    culture: a.culture
                });
            });
            // email senders
            var emailSenders = await this.$api.get('/api/emailing/SmtpSender/GetAllSafe');
            this.emailSenders.splice(0, this.emailSenders.length);
            this.emailSenders.push({
                id: null,
                name: this.$t('no-email-sender')
            });
            emailSenders.forEach(a => {
                this.emailSenders.push({
                    id: a.id,
                    name: a.name
                });
            });
            // sms senders
            var smsSenders = await this.$api.get('/api/smsing/SmsSender/GetAllSafe');
            this.smsSenders.splice(0, this.smsSenders.length);
            this.smsSenders.push({
                id: null,
                name: this.$t('no-sms-sender')
            });
            smsSenders.forEach(a => {
                this.smsSenders.push({
                    id: a.id,
                    name: a.name
                });
            });
        } catch (error) {
            this.toastError(error);
            console.error(error);
        }
    },
    computed: {
        canSetVerificationCodeEmailSender() {
            return this.$user.hasAccess('usermanager_UpdateVerificationCodeEmailSender');
        },
        canSetVerificationCodeSmsSender() {
            return this.$user.hasAccess('usermanager_UpdateVerificationCodeSmsSender');
        },
        canSetVerificationCodeEmailContent() {
            return this.$user.hasAccess('usermanager_UpdateVerificationCodeEmailContent');
        },
        canSetVerificationCodeSmsContent() {
            return this.$user.hasAccess('usermanager_UpdateVerificationCodeSmsContent');
        }
    },
    methods: {
        getLangs() {
            return this.langs;
        },
        getEmailSenderId(emailSender) {
            if (emailSender === undefined || emailSender === null) {
                return undefined;
            }
            return emailSender.id;
        },
        getSmsSenderId(smsSender) {
            if (smsSender === undefined || smsSender === null) {
                return undefined;
            }
            return smsSender.id;
        },
        async setVerificationCodeEmailSender() {
            try {
                this.settingVerificationCodeEmailSender = true;
                await this.$api.post('/api/usermanager/UserManager/SetVerificationCodeEmailSender', {
                    emailSenderId: this.o.verificationCodeEmailSenderId
                });
                this.toastSuccess();
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.settingVerificationCodeEmailSender = false;
            }
        },
        async setVerificationCodeSmsSender() {
            try {
                this.settingVerificationCodeSmsSender = true;
                await this.$api.post('/api/usermanager/UserManager/SetVerificationCodeSmsSender', {
                    smsSenderId: this.o.verificationCodeSmsSenderId
                });
                this.toastSuccess();
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.settingVerificationCodeSmsSender = false;
            }
        },
        async setVerificationCodeEmailSubject() {
            try {
                this.settingVerificationCodeEmailSubject = true;
                await this.$api.post('/api/usermanager/UserManager/SetVerificationCodeEmailSubjectContent', {
                    translations: this.o.emailSubject
                });
                this.toastSuccess();
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.settingVerificationCodeEmailSubject = false;
            }
        },
        async setVerificationCodeEmailBody() {
            try {
                this.settingVerificationCodeEmailBody = true;
                await this.$api.post('/api/usermanager/UserManager/SetVerificationCodeEmailBodyContent', {
                    translations: this.o.emailBody
                });
                this.toastSuccess();
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.settingVerificationCodeEmailBody = false;
            }
        },
        async setVerificationCodeSms() {
            try {
                this.settingVerificationCodeSms = true;
                await this.$api.post('/api/usermanager/UserManager/SetVerificationCodeSmsContent', {
                    translations: this.o.sms
                });
                this.toastSuccess();
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.settingVerificationCodeSms = false;
            }
        },
    }
}
</script>