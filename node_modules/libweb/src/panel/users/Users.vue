<template>
    <b-card :title="$t('title')">
        <w-data-table-server :cols="userCols" @data-provider="loadUsers">
            <span slot="id" slot-scope="a">{{a.value}}</span>
            <span slot="userName" slot-scope="a">{{a.value}}</span>
            <span slot="name" slot-scope="a">{{a.value}}</span>
            <span slot="email" dir="ltr" slot-scope="a">
                <b-button
                    size="sm"
                    v-if="canVerifyEmail && a.value !== null && a.value.length > 0"
                    :variant="a.row.emailConfirmed ? 'success' : 'danger'"
                    :title="a.row.emailConfirmed ? $t('email-confirmed') : $t('email-not-confirmed')"
                    @click="verifyEmail(a.row, !a.row.emailConfirmed)"
                    block
                    :disabled="a.row.verifyingEmail"
                >{{a.value}}</b-button>
                <span
                    v-else
                    :style="{color: a.row.emailConfirmed ? 'green' : 'red'}"
                    :title="a.row.emailConfirmed ? $t('email-confirmed') : $t('email-not-confirmed')"
                >{{a.value}}</span>
            </span>
            <span slot="phoneNumber" dir="ltr" slot-scope="a">
                <b-button
                    size="sm"
                    v-if="canVerifyPhone && a.value !== null && a.value.length > 0"
                    :variant="a.row.phoneNumberConfirmed ? 'success' : 'danger'"
                    :title="a.row.phoneNumberConfirmed ? $t('phone-number-confirmed') : $t('phone-not-confirmed')"
                    @click="verifyPhone(a.row, !a.row.phoneNumberConfirmed)"
                    block
                    :disabled="a.row.verifyingPhone"
                >{{a.value}}</b-button>
                <span
                    v-else
                    :style="{color: a.row.phoneNumberConfirmed ? 'green' : 'red'}"
                    :title="a.row.phoneNumberConfirmed ? $t('phone-number-confirmed') : $t('phone-not-confirmed')"
                >{{a.value}}</span>
            </span>
            <span slot="isMale" slot-scope="a">{{getGender(a.value)}}</span>
            <span slot="opr" slot-scope="a">
                <b-button
                    size="sm"
                    class="mx-1 p-0"
                    v-show="isActive(a.row) ? canLockUser : canUnlockUser"
                    :variant="isActive(a.row) ? 'success' : 'danger'"
                    :title="isActive(a.row) ? $t('is-active') : $t('is-locked', [dateHelper.formatUnixMs(a.row.lockoutEndMs)])"
                    @click="toggleLock(a.row)"
                    :disabled="a.row.togglingLock"
                >
                    <w-mdi :value="isActive(a.row) ? 'lock-open-variant' : 'lock'" :size="18"></w-mdi>
                </b-button>
                <b-button
                    variant="link"
                    size="sm"
                    class="mx-1 p-0"
                    v-show="canEditUser"
                    @click="startEditPermissions(a.row)"
                    :title="$t('permissions')"
                >
                    <w-mdi value="key-change" :size="18"></w-mdi>
                </b-button>
                <b-button
                    variant="link"
                    size="sm"
                    class="mx-1 p-0"
                    v-show="canEditUser"
                    @click="startEditRoles(a.row)"
                    :title="$t('roles')"
                >
                    <w-mdi value="certificate" :size="18"></w-mdi>
                </b-button>
            </span>
        </w-data-table-server>
        <b-modal v-model="lockModal.visible" :title="lockModal.title" size="lg" hide-footer>
            <b-form-group :label="$t('lockout-end-date')">
                <w-date-picker v-model="lockModal.lockoutEndMs"></w-date-picker>
            </b-form-group>
            <b-button class="mt-3" block variant="success" @click="lockUser">{{$t('save')}}</b-button>
        </b-modal>
        <b-modal v-model="permissionsModal.visible" :title="permissionsModal.title" size="lg" hide-footer>
            <permissions v-model="permissionsModal.permissions"></permissions>
            <b-button
                class="mt-3"
                variant="success"
                block
                @click="saveUserPermissions"
                :disabled="permissionsModal.saving"
            >{{$t('save')}}</b-button>
        </b-modal>
        <b-modal v-model="rolesModal.visible" :title="rolesModal.title" size="lg" hide-footer>
            <b-form-group>
                <b-form-checkbox-group v-model="rolesModal.roles" :options="allRoles" stacked switches></b-form-checkbox-group>
            </b-form-group>
            <b-button
                class="mt-3"
                variant="success"
                block
                @click="saveUserRoles"
                :disabled="rolesModal.saving"
            >{{$t('save')}}</b-button>
        </b-modal>
    </b-card>
</template>

<script>
import loc from './Users.i18n.json';
import { i18n } from "../../utility/VueI18n";
import Permissions from '../roles/Permissions.vue';
import { dateHelper } from "../../utility/dateHelper";
import { UrlParser } from "../../utility/url";
export default {
    components: {
        Permissions
    },
    i18n: i18n(loc),
    data() {
        return {
            dateHelper: dateHelper,
            userCols: [
                { header: this.$t('id'), field: 'id', visible: false },
                { header: this.$t('user-name'), field: 'userName' },
                { header: this.$t('name'), field: 'name' },
                { header: this.$t('email'), field: 'email', cellAlign: 'left' },
                { header: this.$t('phone-number'), field: 'phoneNumber', cellAlign: 'left' },
                { header: this.$t('gender'), field: 'isMale' },
                { header: this.$t('opr'), field: 'opr', sortable: false },
            ],
            // array of { text, value }
            allRoles: [],
            lockModal: {
                visible: false,
                title: '',
                user: {},
                lockoutEndMs: moment().valueOf()
            },
            permissionsModal: {
                visible: false,
                title: '',
                user: {},
                saving: false,
                // Array<String>
                permissions: []
            },
            rolesModal: {
                visible: false,
                title: '',
                user: {},
                saving: false,
                // Array<String>
                roles: [],
            }
        };
    },
    async mounted() {
        await this.loadAllRoles();
    },
    methods: {
        getGender(isMale) {
            return isMale === null || isMale === undefined ? '' : isMale ? this.$t('male') : this.$t('female');
        },
        isActive(user) {
            return user.lockoutEndMs === null;
        },
        convertUser(a) {
            a.createDateTime = dateHelper.formatTicks(a.createUtc);
            a.updateDateTime = dateHelper.formatTicks(a.updateUtc);
            a.removing = false;
            a.verifyingEmail = false;
            a.verifyingPhone = false;
            a.togglingLock = false;
            return a;
        },
        async loadAllRoles() {
            try {
                this.allRoles.splice(0, this.allRoles.length);
                var roles = await this.$api.get('/api/usermanager/Role/GetAll');
                roles.forEach(a => {
                    this.allRoles.push({
                        text: a.name,
                        value: a.name
                    });
                });
            } catch (error) {
                this.toastError(error);
                console.error(error);
            }
        },
        async loadUsers(args) {
            try {
                const { search, page, rowsPerPage, sorts, callback } = args;
                var response = await this.$api.post('/api/usermanager/User/GetPaged', {
                    search,
                    page,
                    rowsPerPage,
                    sorts
                });
                callback(response.rows.map(a => this.convertUser(a)), response.totalRows);
            } catch (error) {
                this.toastError(error);
                console.error(error);
            }
        },
        async verifyEmail(user, confirmed) {
            if (await this.toastAsk(this.$t('change-state-question'))) {
                try {
                    user.verifyingEmail = true;
                    await this.$api.post('/api/usermanager/User/VerifyEmail', {
                        userId: user.id,
                        confirmed: confirmed
                    });
                    user.emailConfirmed = confirmed;
                    this.toastSuccess();
                } catch (error) {
                    this.toastError(error);
                    console.error(error);
                } finally {
                    user.verifyingEmail = false;
                }
            }
        },
        async verifyPhone(user, confirmed) {
            if (await this.toastAsk(this.$t('change-state-question'))) {
                try {
                    user.verifyingPhone = true;
                    await this.$api.post('/api/usermanager/User/VerifyPhoneNumber', {
                        userId: user.id,
                        confirmed: confirmed
                    });
                    user.phoneNumberConfirmed = confirmed;
                    this.toastSuccess();
                } catch (error) {
                    this.toastError(error);
                    console.error(error);
                } finally {
                    user.verifyingPhone = false;
                }
            }
        },
        async toggleLockInner(user, untilMs, onSuccess) {
            if (await this.toastAsk(this.$t('change-state-question'))) {
                try {
                    user.togglingLock = true;
                    var action = this.isActive(user) ? 'Lock' : 'Unlock';
                    var args = {
                        userId: user.id
                    };
                    if (this.isActive(user)) {
                        args.untilMs = untilMs;
                    }
                    await this.$api.post(`/api/usermanager/User/${action}`, args);
                    this.toastSuccess();
                    if (this.isActive(user)) {
                        user.lockoutEndMs = untilMs;
                    } else {
                        user.lockoutEndMs = null;
                    }
                    if (onSuccess !== undefined && onSuccess !== null) {
                        onSuccess();
                    }
                } catch (error) {
                    this.toastError(error);
                    console.error(error);
                } finally {
                    user.togglingLock = false;
                }
            }
        },
        toggleLock(user) {
            if (!this.isActive(user)) {
                this.toggleLockInner(user, null);
            } else {
                this.lockModal.user = user;
                this.lockModal.title = this.$t('lock-user', [user.userName]);
                this.lockModal.visible = true;
            }
        },
        lockUser() {
            this.toggleLockInner(this.lockModal.user, this.lockModal.lockoutEndMs, () => {
                // close modal
                this.lockModal.visible = false;
            });
        },
        async loadUserPermissions(user) {
            try {
                const urlParser = new UrlParser();
                var urlObject = urlParser.parse('/api/usermanager/User/GetPermissions');
                urlObject.query.userId = user.id;
                var url = urlObject.toRelative();
                var res = await this.$api.get(url);
                return res;
            } catch (error) {
                this.toastError(error);
                console.error(error);
                return null;
            }
        },
        async startEditPermissions(user) {
            var permissions = await this.loadUserPermissions(user);
            if (permissions === undefined || permissions === null) {
                return;
            }
            this.permissionsModal.permissions.splice(0, this.permissionsModal.permissions.length);
            permissions.forEach(p => {
                this.permissionsModal.permissions.push(p);
            });
            this.permissionsModal.user = Object.assign({}, user);
            this.permissionsModal.title = this.$t('edit-permissions', [user.userName]);
            this.permissionsModal.visible = true;
        },
        async saveUserPermissions() {
            try {
                this.permissionsModal.saving = true;
                await this.$api.post('/api/usermanager/User/UpdatePermissions', {
                    userId: this.permissionsModal.user.id,
                    permissions: this.permissionsModal.permissions
                });
                this.toastSuccess();
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.permissionsModal.saving = false;
            }
        },
        async loadUserRoles(user) {
            try {
                const urlParser = new UrlParser();
                var urlObject = urlParser.parse('/api/usermanager/User/GetRoles');
                urlObject.query.userId = user.id;
                var url = urlObject.toRelative();
                var res = await this.$api.get(url);
                return res;
            } catch (error) {
                this.toastError(error);
                console.error(error);
                return null;
            }
        },
        async startEditRoles(user) {
            var roles = await this.loadUserRoles(user);
            if (roles === undefined || roles === null) {
                return;
            }
            this.rolesModal.roles.splice(0, this.rolesModal.roles.length);
            roles.forEach(a => {
                this.rolesModal.roles.push(a.name);
            });
            this.rolesModal.user = Object.assign({}, user);
            this.rolesModal.title = this.$t('edit-roles', [user.userName]);
            this.rolesModal.visible = true;
        },
        async saveUserRoles() {
            try {
                this.rolesModal.saving = true;
                await this.$api.post('/api/usermanager/User/UpdateRoles', {
                    userId: this.rolesModal.user.id,
                    roles: this.rolesModal.roles
                });
                this.toastSuccess();
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.rolesModal.saving = false;
            }
        },
    },
    computed: {
        canViewUsers() {
            return this.$user.hasAccess(['usermanager_ViewUsers', 'usermanager_ViewPermissions']);
        },
        canLockUser() {
            return this.$user.hasAccess('usermanager_LockUser');
        },
        canUnlockUser() {
            return this.$user.hasAccess('usermanager_UnlockUser');
        },
        canEditUser() {
            return this.$user.hasAccess('usermanager_UpdateUser');
        },
        canVerifyEmail() {
            return this.$user.hasAccess('usermanager_VerifyEmail');
        },
        canVerifyPhone() {
            return this.$user.hasAccess('usermanager_VerifyPhoneNumber');
        }
    }
}
</script>