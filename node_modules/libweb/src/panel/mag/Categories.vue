<template>
    <b-card :title="$t('title')">
        <div class="row">
            <div class="col-12" style="padding-bottom: 0;">
                <div
                    class="d-flex align-items-center h-100"
                    style="overflow-x: auto;padding-bottom: 2px;padding-top: 2px;"
                >
                    <b-button
                        variant="success"
                        @click="e => startAdd(null, e)"
                        v-show="canAddCategory"
                    >{{$t('add-category')}}</b-button>
                </div>
            </div>
            <w-tree
                :items="categories"
                id-prop="id"
                parent-id-prop="parentId"
                order-prop="order"
                :empty-parent-id="emptyParentId"
                :expanded-first="true"
                @move="onMove"
                v-show="canViewCategories && ready"
            >
                <div slot="text" slot-scope="{node}">{{node.data.name}}</div>
                <div slot="controls" slot-scope="{node}">
                    <b-button
                        variant="success"
                        @click="e => startAdd(node.data.id, e)"
                        v-show="canAddCategory"
                        :title="$t('add-category')"
                        size="sm"
                    >+</b-button>
                    <b-button
                        variant="info"
                        @click="e => startEdit(node.data, e)"
                        v-show="canEditCategory"
                        :title="$t('edit')"
                        size="sm"
                        class="ml-1 p-0"
                    >
                        <w-mdi :size="18" value="pencil"></w-mdi>
                    </b-button>
                    <b-button
                        variant="danger"
                        @click="e => remove(node.data, e)"
                        v-show="canDeleteCategory"
                        :title="$t('delete')"
                        size="sm"
                        class="ml-1 p-0"
                        :disabled="node.data.removing"
                    >
                        <w-mdi :size="18" value="delete"></w-mdi>
                    </b-button>
                    <b-button
                        variant="link"
                        @click="e => toggleVisibility(node.data, e)"
                        :disabled="node.data.togglingVisibility"
                        :title="node.data.visible ? $t('visible') : $t('hidden')"
                        size="sm"
                        class="ml-1 p-0"
                    >
                        <w-mdi :size="18" :value="node.data.visible ? 'eye' : 'eye-off'" />
                    </b-button>
                    <b-button
                        variant="link"
                        @click="e => showTranslations(node.data, e)"
                        :title="$t('translations')"
                        size="sm"
                        class="ml-1 p-0"
                    >
                        <w-mdi :size="18" value="translate" />
                    </b-button>
                    <b-button
                        variant="link"
                        @click="e => showPosts(node.data, e)"
                        :title="$t('posts')"
                        size="sm"
                        class="ml-1 p-0"
                    >
                        <w-mdi :size="18" value="newspaper" />
                    </b-button>
                </div>
            </w-tree>
            <b-modal v-model="modal.visible" hide-footer size="lg" :title="modal.title">
                <b-form-group
                    :label="$t('name')"
                    :state="nameState"
                    :invalid-feedback="invalidName"
                    label-cols-lg="2"
                    label-cols-md="3"
                    label-align-md="right"
                >
                    <b-form-input trim v-model="modal.item.name"></b-form-input>
                </b-form-group>
                <b-form-group label-cols-lg="2" label-cols-md="3" label-align-md="right">
                    <b-form-checkbox v-model="modal.item.visible" switch>{{$t('visible')}}</b-form-checkbox>
                </b-form-group>
                <b-button
                    class="mt-3"
                    block
                    variant="success"
                    :disabled="modal.saving || !nameState"
                    @click="save"
                >{{$t('save')}}</b-button>
            </b-modal>
            <category-translations v-model="translationsVisible" :category="category" :langs="getLangs()"></category-translations>
            <w-posts
                v-model="postsVisible"
                container-name="magazine"
                :container-id="category.id"
                :title="postsTitle"
                :langs="getLangs()"
            ></w-posts>
        </div>
    </b-card>
</template>

<script>
import { guid } from "../../utility/guid";
import messages from './Categories.i18n.json';
import CategoryTranslations from './CategoryTranslations.vue';
import WPosts from '../../components/mag/WPosts.vue';
import { i18n } from '../../utility/VueI18n';
import { dateHelper } from '../../utility/dateHelper';
export default {
    components: {
        CategoryTranslations,
        WPosts
    },
    i18n: i18n(messages),
    props: {
        // array of {code, direction, name}
        langs: {
            default() {
                return [];
            }
        }
    },
    data() {
        return {
            emptyParentId: guid.empty(),
            ready: false,
            categories: [],
            modal: {
                title: '',
                visible: false,
                isNew: false,
                saving: false,
                item: {}
            },
            translationsVisible: false,
            category: {},
            postsVisible: false,
            postsTitle: ''
        };
    },
    async mounted() {
        await this.loadCategories();
    },
    methods: {
        getLangs() {
            return this.langs;
        },
        isEmpty(a) {
            return a === undefined || a === null || a.length === 0;
        },
        convert(a) {
            a.createDateTime = dateHelper.formatTicks(a.createUtc);
            a.updateDateTime = dateHelper.formatTicks(a.updateUtc);
            a.removing = false;
            a.togglingVisibility = false;
            return a;
        },
        empty() {
            var nowTicks = moment().valueOf() * 10000;
            var res = {
                id: '',
                createUtc: nowTicks,
                updateUtc: nowTicks,
                description: '',
                parentId: '',
                order: 0,
                name: '',
                visible: false
            };
            return this.convert(res);
        },
        async loadCategories() {
            try {
                this.ready = false;
                var list = await this.$api.get('/api/mag/Category/ViewCategories');
                list.forEach(a => {
                    this.categories.push(this.convert(a));
                });
                this.ready = true;
            } catch (error) {
                this.toastError(error);
                console.error(error);
            }
        },
        startAdd(parentId, e) {
            e.stopPropagation();
            this.modal.title = this.$t('add-new-category');
            this.modal.isNew = true;
            this.modal.item = Object.assign({}, this.empty());
            if (!this.isEmpty(parentId)) {
                this.modal.item.parentId = parentId;
            }
            this.modal.visible = true;
        },
        startEdit(item, e) {
            e.stopPropagation();
            this.modal.title = this.$t('edit-category');
            this.modal.isNew = false;
            this.modal.item = Object.assign({}, item);
            this.modal.visible = true;
        },
        async save() {
            var item = this.modal.item;
            try {
                this.modal.saving = true;
                if (this.modal.isNew) {
                    // add
                    var args = {
                        parentId: item.parentId,
                        name: item.name,
                        visible: item.visible
                    };
                    var category = await this.$api.post('/api/mag/Category/AddCategory', args);
                    this.categories.push(this.convert(category));
                } else {
                    // update
                    var args = {
                        id: item.id,
                        name: item.name,
                        visible: item.visible
                    };
                    await this.$api.post('/api/mag/Category/UpdateCategory', args);
                    var i = this.categories.findIndex(a => a.id === item.id);
                    if (i > -1) {
                        this.$set(this.categories, i, item);
                    }
                }
                this.toastSuccess();
                this.modal.visible = false;
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.modal.saving = false;
            }
        },
        getSelfAndDescendants(node) {
            var recurse = a => {
                var res = [a];
                var children = this.categories.filter(a => a.parentId === a.id);
                if (children.length > 0) {
                    children.forEach(c => {
                        var k = recurse(c);
                        k.forEach(cc => {
                            res.push(cc);
                        });
                    });
                }
                return res;
            }
            return recurse(node);
        },
        async remove(item, e) {
            e.stopPropagation();
            if (await this.toastAsk()) {
                try {
                    item.removing = true;
                    await this.$api.post('/api/mag/Category/DeleteCategory', {
                        id: item.id
                    });
                    this.toastSuccess();
                    var itemAndDescendants = this.getSelfAndDescendants(item);
                    var indices = itemAndDescendants.map(a => this.categories.findIndex(c => a.id === c.id));
                    indices.sort((a, b) => { return b - a; });
                    for (var i = indices.length - 1; i >= 0; i--) {
                        this.categories.splice(indices[i], 1);
                    }
                } catch (error) {
                    this.toastError(error);
                    console.error(error);
                } finally {
                    item.removing = false;
                }
            }
        },
        async toggleVisibility(item, e) {
            e.stopPropagation();
            if (await this.toastAsk()) {
                try {
                    item.togglingVisibility = true;
                    var args = {
                        id: item.id,
                        name: item.name,
                        visible: !item.visible
                    };
                    await this.$api.post('/api/mag/Category/UpdateCategory', args);
                    item.visible = !item.visible;
                    var i = this.categories.findIndex(a => a.id === item.id);
                    if (i > -1) {
                        this.$set(this.categories, i, item);
                    }
                    this.toastSuccess();
                } catch (error) {
                    this.toastError(error);
                    console.error(error);
                } finally {
                    item.togglingVisibility = false;
                }
            }
        },
        async onMove() {
            const { node, parentNode, parentChildren, completed } = arguments[0];
            const nodeId = node.data.id;
            const nodeName = node.data.name;
            const parentId = parentNode === undefined || parentNode === null ? this.emptyParentId : parentNode.data.id;
            const childrenIds = parentChildren.map(a => a.data.id);
            const children = childrenIds.map(id => this.categories.find(c => id === c.id));

            // log
            const parentName = parentNode === undefined || parentNode === null ? '-' : parentNode.data.name;
            console.log(parentId, parentName, children.map(a => a.name));

            try {
                var args = {
                    id: nodeId,
                    parentId: parentId,
                    orderItems: children.map((a, i) => {
                        return {
                            id: a.id,
                            order: i
                        };
                    })
                };
                await this.$api.post('/api/mag/Category/MoveCategory', args);
                this.toastSuccess();
                setTimeout(() => {
                    window.location.reload(true);
                }, 1500);
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                completed();
            }
        },
        showTranslations(item, e) {
            e.stopPropagation();
            this.category = item;
            this.translationsVisible = true;
        },
        showPosts(item, e) {
            e.stopPropagation();
            this.category = item;
            this.postsTitle = this.$t('category-posts', [this.category.name]);
            this.postsVisible = true;
        },
    },
    computed: {
        canViewCategories() {
            return this.$user.hasAccess('mag_ViewCategories');
        },
        canAddCategory() {
            return this.$user.hasAccess('mag_AddCategory');
        },
        canEditCategory() {
            return this.$user.hasAccess('mag_UpdateCategory');
        },
        canDeleteCategory() {
            return this.$user.hasAccess('mag_DeleteCategory');
        },
        nameState() {
            return !this.isEmpty(this.modal.item.name);
        },
        invalidName() {
            if (this.nameState) {
                return '';
            }
            return this.$t('name-required');
        },
    }
}
</script>