<template>
    <b-modal v-model="visible" hide-footer size="lg" :title="title">
        <w-data-table-client :rows="translations" :cols="cols" v-show="canViewCategories">
            <span slot="actions">
                <b-button
                    class="ml-1"
                    variant="success"
                    @click="startAdd"
                    v-show="remainingCultures().length > 0"
                >{{$t('add-translation')}}</b-button>
            </span>
            <span slot="id" slot-scope="{value, row}">{{value}}</span>
            <span slot="culture" slot-scope="{value, row}">{{getCultureName(value)}}</span>
            <span slot="title" slot-scope="{value, row}">{{value}}</span>
            <span slot="name" slot-scope="{value, row}">{{value}}</span>
            <span slot="createDateTime" slot-scope="{value, row}">{{value}}</span>
            <span slot="updateDateTime" slot-scope="{value, row}">{{value}}</span>
            <span slot="opr" slot-scope="{value, row}">
                <b-button
                    variant="info"
                    class="ml-1 p-0"
                    size="sm"
                    @click="startEdit(row)"
                    v-show="canEditCategory"
                    :title="$t('edit')"
                >
                    <w-mdi :size="18" value="pencil" />
                </b-button>
                <b-button
                    variant="danger"
                    class="ml-1 p-0"
                    size="sm"
                    @click="remove(row)"
                    :disabled="row.removing"
                    v-show="canEditCategory"
                    :title="$t('delete')"
                >
                    <w-mdi :size="18" value="delete" />
                </b-button>
            </span>
        </w-data-table-client>
        <b-modal
            v-model="modal.visible"
            hide-footer
            size="lg"
            :title="modal.title"
        >
            <b-form-group
                :label="$t('culture')"
                :state="cultureState"
                :invalid-feedback="invalidCulture"
                v-if="modal.isNew"
                label-cols-lg="2"
                label-cols-md="3"
                label-align-md="right"
            >
                <b-form-select :options="remainingCultures()" v-model="modal.item.culture" />
            </b-form-group>
            <b-form-group
                :label="$t('name')"
                :state="nameState"
                :invalid-feedback="invalidName"
                label-cols-lg="2"
                label-cols-md="3"
                label-align-md="right"
            >
                <b-form-input trim v-model="modal.item.name" :dir="getCultureDirection(modal.item.culture)" />
            </b-form-group>
            <b-form-group
                :label="$t('title')"
                :state="titleState"
                :invalid-feedback="invalidTitle"
                label-cols-lg="2"
                label-cols-md="3"
                label-align-md="right"
            >
                <b-form-input trim v-model="modal.item.title" :dir="getCultureDirection(modal.item.culture)" />
            </b-form-group>
            <b-form-group :label="$t('subtitle')" label-cols-lg="2" label-cols-md="3" label-align-md="right">
                <b-form-textarea
                    v-model="modal.item.subtitle"
                    :rows="3"
                    :max-rows="6"
                    :dir="getCultureDirection(modal.item.culture)"
                />
            </b-form-group>
            <b-form-group :label="$t('thumbs')" label-cols-lg="2" label-cols-md="3" label-align-md="right">
                <w-image-select v-model="modal.item.thumbArray"></w-image-select>
            </b-form-group>
            <b-button
                block
                variant="success"
                class="mt-3"
                :disabled="modal.saving || !nameState || !titleState || (modal.isNew && !cultureState)"
                @click="save"
            >{{$t('save')}}</b-button>
        </b-modal>
    </b-modal>
</template>

<script>
import messages from './CategoryTranslations.i18n.json';
import { i18n } from '../../utility/VueI18n';
import { dateHelper } from '../../utility/dateHelper';
export default {
    i18n: i18n(messages),
    props: {
        value: {
            default: false
        },
        category: {
            default() {
                return {};
            }
        },
        // array of {code, direction, name}
        langs: {
            default() {
                return [];
            }
        }
    },
    data() {
        return {
            visible: false,
            translations: [],
            cols: [
                { header: this.$t('id'), field: 'id', visible: false, sortable: false, },
                { header: this.$t('culture'), field: 'culture' },
                { header: this.$t('name'), field: 'name' },
                { header: this.$t('title'), field: 'title' },
                { header: this.$t('subtitle'), field: 'subtitle', visible: false },
                { header: this.$t('createDateTime'), field: 'createDateTime' },
                { header: this.$t('updateDateTime'), field: 'updateDateTime' },
                { header: this.$t('operations'), field: 'opr', sortable: false },
            ],
            modal: {
                title: '',
                isNew: false,
                item: {},
                visible: false,
                saving: false
            },
            cultures: this.langs.map(a => {
                return {
                    text: a.name,
                    value: a.code
                };
            })
        };
    },
    methods: {
        isEmpty(a) {
            return a === undefined || a === null || a.length === 0;
        },
        isVoid(a) {
            return a === undefined || a === null;
        },
        convert(a) {
            a.createDateTime = dateHelper.formatTicks(a.createUtc);
            a.updateDateTime = dateHelper.formatTicks(a.updateUtc);
            a.removing = false;
            a.thumbArray = this.isEmpty(a.thumbs) ? [] : a.thumbs.split('|');
            return a;
        },
        empty() {
            var nowTicks = moment().valueOf() * 10000;
            var res = {
                id: '',
                createUtc: nowTicks,
                updateUtc: nowTicks,
                description: '',
                categoryId: '',
                name: '',
                title: '',
                subtitle: '',
                thumbs: '',
                culture: ''
            };
            return this.convert(res);
        },
        getCategory() {
            if (this.isVoid(this.category)) {
                return {};
            }
            return this.category;
        },
        async onShown() {
            try {
                this.translations.splice(0, this.translations.length);
                var list = await this.$api.post('/api/mag/Category/ViewCategoryTranslations', {
                    categoryId: this.category.id
                });
                list.forEach(a => {
                    this.translations.push(this.convert(a));
                });
            } catch (error) {
                this.toastError(error);
                console.error(error);
                // close
                this.visible = false;
            }
        },
        onHidden() {
            this.translations.splice(0, this.translations.length);
        },
        startAdd() {
            this.modal.title = this.$t('add-new-translation');
            this.modal.isNew = true;
            this.modal.item = Object.assign({}, this.empty());
            this.modal.visible = true;
        },
        startEdit(item) {
            const idx = this.langs.findIndex(a => a.code === item.culture);
            this.modal.title = this.$t('edit-translation', [this.langs[idx].name]);
            this.modal.isNew = false;
            this.modal.item = Object.assign({}, item);
            this.modal.visible = true;
        },
        async save() {
            var item = this.modal.item;
            try {
                this.modal.saving = true;
                var args = {
                    name: item.name,
                    title: item.title,
                    subtitle: item.subtitle,
                    thumbs: item.thumbArray
                };
                if (this.modal.isNew) {
                    // add
                    args.categoryId = this.category.id;
                    args.culture = item.culture;
                    var tra = await this.$api.post('/api/mag/Category/AddTranslation', args);
                    this.translations.push(this.convert(tra));
                } else {
                    // update
                    args.id = item.id;
                    await this.$api.post('/api/mag/Category/UpdateTranslation', args);
                    var i = this.translations.findIndex(a => a.id === item.id);
                    if (i > -1) {
                        this.$set(this.translations, i, item);
                    }
                }
                this.toastSuccess();
                this.modal.visible = false;
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.modal.saving = false;
            }
        },
        async remove(item) {
            if (await this.toastAsk()) {
                try {
                    item.removing = true;
                    await this.$api.post('/api/mag/Category/DeleteTranslation', {
                        id: item.id
                    });
                    this.toastSuccess();
                    var i = this.translations.findIndex(a => a.id === item.id);
                    if (i > -1) {
                        this.translations.splice(i, 1);
                    }
                } catch (error) {
                    this.toastError(error);
                    console.error(error);
                } finally {
                    item.removing = false;
                }
            }
        },
        getCultureName(culture) {
            if (this.isEmpty(culture)) {
                return 'Unknown';
            }
            const idx = this.langs.findIndex(a => a.code === culture);
            return this.langs[idx].name;
        },
        getCultureDirection(culture) {
            if (this.isEmpty(culture)) {
                return 'ltr';
            }
            const idx = this.langs.findIndex(a => a.code === culture);
            return this.langs[idx].direction;
        },
        remainingCultures() {
            return this.cultures.filter(a => {
                var i = this.translations.findIndex(t => t.culture === a.value);
                return i < 0;
            });
        }
    },
    computed: {
        title() {
            var categoryName = this.getCategory().name;
            return this.$t('modal-title', [categoryName]);
        },
        canViewCategories() {
            return this.$user.hasAccess('mag_ViewCategories');
        },
        canEditCategory() {
            return this.$user.hasAccess('mag_UpdateCategory');
        },
        nameState() {
            return !this.isEmpty(this.modal.item.name);
        },
        invalidName() {
            if (this.nameState) {
                return '';
            }
            return this.$t('name-required');
        },
        titleState() {
            return !this.isEmpty(this.modal.item.title);
        },
        invalidTitle() {
            if (this.titleState) {
                return '';
            }
            return this.$t('title-required');
        },
        cultureState() {
            return !this.isEmpty(this.modal.item.culture);
        },
        invalidCulture() {
            if (this.cultureState) {
                return '';
            }
            return this.$t('culture-required');
        }
    },
    watch: {
        value() {
            if (this.value === this.visible) {
                return;
            }
            this.visible = this.value;
        },
        async visible() {
            if (this.visible) {
                await this.onShown();
            } else {
                this.onHidden();
            }
            if (this.value === this.visible) {
                return;
            }
            this.$emit('input', this.visible);
        }
    }
}
</script>