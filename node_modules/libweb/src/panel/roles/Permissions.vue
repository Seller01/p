<template>
    <div>
        <b-button variant="success" size="sm" @click="selectAll">{{$t('select-all')}}</b-button>
        <b-button variant="danger" size="sm" @click="unselectAll">{{$t('unselect-all')}}</b-button>
        <hr />
        <template v-for="g in permissionGroups">
            <div :key="g.moduleName" v-if="g.permissions.length > 0">
                <b-form-group :label="g.moduleName">
                    <b-form-checkbox-group v-model="selected" :options="g.permissions" stacked switches />
                </b-form-group>
                <hr />
            </div>
        </template>
    </div>
</template>

<script>
import loc from './Permissions.i18n.json';
import { i18n } from "../../utility/VueI18n";
export default {
    i18n: i18n(loc),
    props: {
        // Array<String>
        value: {
            default() {
                return [];
            }
        },
    },
    data() {
        return {
            loadedPermissions: false,
            // array of { moduleName: String, permissions: array of { text, value } }
            permissionGroups: [],
            selected: [],
        };
    },
    async mounted() {
        await this.loadPermissions();
        if (this.loadedPermissions) {
            this.valueChanged();
        }
    },
    methods: {
        async loadPermissions() {
            try {
                this.permissionGroups.splice(0, this.permissionGroups.length);
                this.loadedPermissions = false;
                var permissionGroups = await this.$api.get('/api/usermanager/Permission/GetAll');
                permissionGroups.forEach(g => {
                    this.permissionGroups.push({
                        moduleName: g.moduleName,
                        permissions: g.permissions
                    });
                });
                this.loadedPermissions = true;
            } catch (error) {
                this.toastError(error);
                console.error(error);
            }
        },
        valueChanged() {
            this.selected.splice(0, this.selected.length);
            this.value.forEach(a => {
                this.selected.push(a);
            });
        },
        selectAll() {
            var res = [];
            this.permissionGroups.forEach(g => {
                g.permissions.forEach(a => {
                    res.push(a.value);
                });
            });
            this.$emit('input', res);
        },
        unselectAll() {
            this.$emit('input', []);
        }
    },
    watch: {
        value: {
            handler() {
                if (_.isEqual(this.selected, this.value)) {
                    return;
                }
                this.valueChanged();
            },
            deep: true
        },
        selected: {
            handler() {
                if (_.isEqual(this.selected, this.value)) {
                    return;
                }
                this.$emit('input', this.selected);
            },
            deep: true
        }
    }
}
</script>