<template>
    <b-card :title="$t('title')">
        <w-data-table-client :rows="roles" :cols="roleCols" v-show="canViewRoles && ready">
            <div slot="actions" class="mx-1">
                <b-button variant="success" @click="startAddRole" v-show="canAddRole">{{$t('add-role')}}</b-button>
            </div>
            <span slot="id" slot-scope="a">{{a.value}}</span>
            <span slot="name" slot-scope="a">{{a.value}}</span>
            <span slot="createDateTime" slot-scope="a">{{a.value}}</span>
            <span slot="updateDateTime" slot-scope="a">{{a.value}}</span>
            <span slot="description" slot-scope="a">{{$shorten(a.value, 15)}}</span>
            <span slot="opr" slot-scope="a">
                <b-button
                    variant="info"
                    size="sm"
                    class="mx-1 p-0"
                    v-show="canEditRole && !isAdmin(a.row)"
                    @click="startEdit(a.row)"
                    :title="$t('edit')"
                >
                    <w-mdi value="pencil" :size="18"></w-mdi>
                </b-button>
                <b-button
                    variant="link"
                    size="sm"
                    class="mx-1 p-0"
                    v-show="canEditRole && !isAdmin(a.row)"
                    @click="startEditPermissions(a.row)"
                    :title="$t('permissions')"
                >
                    <w-mdi value="key-change" :size="18"></w-mdi>
                </b-button>
                <b-button
                    variant="danger"
                    size="sm"
                    class="mx-1 p-0"
                    v-show="canDeleteRole && !isAdmin(a.row)"
                    @click="remove(a.row)"
                    :disabled="a.row.removing"
                    :title="$t('delete')"
                >
                    <w-mdi value="delete" :size="18"></w-mdi>
                </b-button>
            </span>
        </w-data-table-client>
        <b-modal v-model="editRoleModal.visible" :title="editRoleModal.title" size="lg" hide-footer>
            <b-form-group
                :label="$t('name')"
                label-for="roles-role-name"
                :invalid-feedback="invalidRoleName"
                :state="roleNameState"
                label-cols-md="3"
                label-cols-lg="2"
                label-align-md="right"
            >
                <b-form-input trim v-model="editRoleModal.model.name" id="roles-role-name"></b-form-input>
            </b-form-group>
            <b-button
                variant="success"
                class="mt-3"
                block
                @click="save"
                :disabled="editRoleModal.saving || !roleNameState"
            >{{$t('save')}}</b-button>
        </b-modal>
        <b-modal v-model="permissionsModal.visible" :title="permissionsModal.title" size="lg" hide-footer>
            <permissions v-model="permissionsModal.permissions"></permissions>
            <b-button
                class="mt-3"
                variant="success"
                block
                @click="saveRolePermissions"
                :disabled="permissionsModal.saving"
            >{{$t('save')}}</b-button>
        </b-modal>
    </b-card>
</template>

<script>
import loc from './Roles.i18n.json';
import { i18n } from "../../utility/VueI18n";
import Permissions from './Permissions.vue';
import { dateHelper } from "../../utility/dateHelper";
import { UrlParser } from "../../utility/url";
export default {
    components: {
        Permissions
    },
    i18n: i18n(loc),
    data() {
        return {
            ready: false,
            // array of { id, createUtc, updateUtc, description, name, createDateTime, updateDateTime, removing }
            roles: [],
            roleCols: [
                { header: this.$t('id'), field: 'id', visible: false, sortable: false },
                { header: this.$t('name'), field: 'name' },
                { header: this.$t('createDateTime'), field: 'createDateTime' },
                { header: this.$t('updateDateTime'), field: 'updateDateTime' },
                { header: this.$t('description'), field: 'description', sortable: false },
                { header: this.$t('opr'), field: 'opr', sortable: false }
            ],
            editRoleModal: {
                visible: false,
                isNew: false,
                title: '',
                saving: false,
                model: {}
            },
            permissionsModal: {
                visible: false,
                title: '',
                role: {},
                saving: false,
                // Array<String>
                permissions: []
            }
        };
    },
    async mounted() {
        await this.loadRoles();
    },
    methods: {
        convertRole(a) {
            a.createDateTime = dateHelper.formatTicks(a.createUtc);
            a.updateDateTime = dateHelper.formatTicks(a.updateUtc);
            a.removing = false;
            return a;
        },
        emptyRole() {
            var nowTicks = moment().valueOf() * 10000;
            var res = {
                id: '',
                createUtc: nowTicks,
                updateUtc: nowTicks,
                description: '',
                name: ''
            };
            return this.convertRole(res);
        },
        async loadRoles() {
            try {
                this.roles.splice(0, this.roles.length);
                this.ready = false;
                var roles = await this.$api.get('/api/usermanager/Role/GetAll');
                roles.forEach(role => {
                    this.roles.push(this.convertRole(role));
                });
                this.ready = true;
            } catch (error) {
                this.toastError(error);
                console.error(error);
            }
        },
        startAddRole() {
            this.editRoleModal.model = Object.assign({}, this.emptyRole());
            this.editRoleModal.title = this.$t('add-new-role');
            this.editRoleModal.isNew = true;
            this.editRoleModal.visible = true;
        },
        startEdit(role) {
            this.editRoleModal.model = Object.assign({}, this.emptyRole(), role);
            this.editRoleModal.title = this.$t('edit-role');
            this.editRoleModal.isNew = false;
            this.editRoleModal.visible = true;
        },
        async save() {
            try {
                this.editRoleModal.saving = true;
                var role = this.editRoleModal.model;
                if (this.editRoleModal.isNew) {
                    // add
                    var newRole = await this.$api.post('/api/usermanager/Role/Add', {
                        name: role.name,
                        description: role.description
                    });
                    this.roles.push(this.convertRole(newRole));
                } else {
                    // update
                    var newRole = await this.$api.post('/api/usermanager/Role/Update', {
                        id: role.id,
                        name: role.name,
                        description: role.description
                    });
                    var i = this.roles.findIndex(a => a.id === role.id);
                    if (i > -1) {
                        this.$set(this.roles, i, this.convertRole(newRole));
                    }
                }
                this.toastSuccess();
                this.editRoleModal.visible = false;
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.editRoleModal.saving = false;
            }
        },
        async remove(role) {
            if (await this.toastAsk()) {
                try {
                    role.removing = true;
                    await this.$api.post('/api/usermanager/Role/Delete', {
                        id: role.id
                    });
                    var i = this.roles.findIndex(a => a.id === role.id);
                    if (i > -1) {
                        this.roles.splice(i, 1);
                    }
                    this.toastSuccess();
                } catch (error) {
                    this.toastError(error);
                    console.error(error);
                } finally {
                    role.removing = false;
                }
            }
        },
        async loadRolePermissions(role) {
            try {
                const urlParser = new UrlParser();
                var urlObject = urlParser.parse('/api/usermanager/Role/GetPermissions');
                urlObject.query.roleId = role.id;
                var url = urlObject.toRelative();
                var res = await this.$api.get(url);
                return res;
            } catch (error) {
                this.toastError(error);
                console.error(error);
                return null;
            }
        },
        async startEditPermissions(role) {
            var permissions = await this.loadRolePermissions(role);
            if (permissions === undefined || permissions === null) {
                return;
            }
            this.permissionsModal.permissions.splice(0, this.permissionsModal.permissions.length);
            permissions.forEach(p => {
                this.permissionsModal.permissions.push(p);
            });
            this.permissionsModal.role = Object.assign({}, role);
            this.permissionsModal.title = this.$t('edit-role-permissions', [role.name]);
            this.permissionsModal.visible = true;
        },
        async saveRolePermissions() {
            try {
                this.permissionsModal.saving = true;
                await this.$api.post('/api/usermanager/Role/UpdatePermissions', {
                    roleId: this.permissionsModal.role.id,
                    permissions: this.permissionsModal.permissions
                });
                this.toastSuccess();
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.permissionsModal.saving = false;
            }
        },
        isAdmin(role) {
            return role.name.toLowerCase() === 'admin';
        }
    },
    computed: {
        canViewRoles() {
            return this.$user.hasAccessAll(['usermanager_ViewRoles', 'usermanager_ViewPermissions']);
        },
        canAddRole() {
            return this.$user.hasAccess('usermanager_AddRole');
        },
        canEditRole() {
            return this.$user.hasAccess('usermanager_UpdateRole');
        },
        canDeleteRole() {
            return this.$user.hasAccess('usermanager_DeleteRole');
        },
        roleNameState() {
            var n = this.editRoleModal.model.name;
            return n !== undefined && n !== null && n.length > 0;
        },
        invalidRoleName() {
            if (this.roleNameState) {
                return '';
            }
            return this.$t('role-name-required');
        }
    }
}
</script>