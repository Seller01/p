<template>
    <b-card :title="$t('title')">
        <div class="row">
            <div class="col-12 col-md-6">
                <b-card>
                    <b-form-group
                        :label="$t('name')"
                        label-for="profile-name"
                        :state="nameState"
                        :invalid-feedback="invalidName"
                        label-cols-md="4"
                        label-cols-lg="3"
                        label-align-md="right"
                    >
                        <b-form-input id="profile-name" v-model="o.name" trim :disabled="savingName"></b-form-input>
                    </b-form-group>
                    <b-button
                        variant="success"
                        block
                        @click="saveName"
                        class="mt-3"
                        :disabled="savingName"
                    >{{$t('save')}}</b-button>
                </b-card>
                <b-card class="mt-3">
                    <b-form-group
                        :label="$t('birth-date')"
                        label-for="profile-birth-date"
                        label-cols-md="4"
                        label-cols-lg="3"
                        label-align-md="right"
                    >
                        <w-date-picker v-model="o.birthDateMs" type="date" :disabled="savingBirthDate"></w-date-picker>
                    </b-form-group>
                    <b-button
                        variant="success"
                        block
                        @click="saveBirthDate"
                        class="mt-3"
                        :disabled="savingBirthDate"
                    >{{$t('save')}}</b-button>
                </b-card>
                <b-card class="mt-3" v-show="canSetPhone">
                    <phone-confirmation v-model="o.phoneConfirmed" :phone="origPhone"></phone-confirmation>
                    <hr />
                    <b-form-group
                        :label="$t('phone-number')"
                        label-for="profile-phone"
                        :invalid-feedback="invalidPhone"
                        :state="phoneState"
                    >
                        <w-phone-input v-model="o.phone" :disabled="settingPhone"></w-phone-input>
                    </b-form-group>
                    <b-form-group
                        :label="$t('password')"
                        label-for="profile-password-for-phone"
                        :state="passwordState"
                        :invalid-feedback="invalidPassword"
                        v-show="readyToSetPhone"
                    >
                        <b-form-input
                            type="password"
                            id="profile-password-for-phone"
                            v-model="password"
                            :disabled="settingPhone"
                            dir="ltr"
                        ></b-form-input>
                    </b-form-group>
                    <w-verify-code
                        v-model="verifyingPhone"
                        type="phone"
                        :phone="o.phone"
                        :request-url="urlParser.localizeUrl('/api/usermanager/Profile/RequestCodeForSettingPhone').toRelative()"
                        :verify-url="urlParser.localizeUrl('/api/usermanager/Profile/VerifyCodeForSettingPhone').toRelative()"
                        @done="phoneVerified"
                    ></w-verify-code>
                    <b-button
                        variant="primary"
                        block
                        @click="verifyPhone"
                        class="mt-3"
                        :disabled="verifyingPhone"
                        v-show="phoneState && phoneChanged && !readyToSetPhone"
                    >{{$t('verify-phone')}}</b-button>
                    <b-button
                        variant="success"
                        block
                        @click="setPhone"
                        class="mt-3"
                        :disabled="settingPhone"
                        v-show="phoneState && phoneChanged && readyToSetPhone"
                    >{{$t('save')}}</b-button>
                </b-card>
            </div>
            <div class="col-12 col-md-6 mt-3 mt-md-0">
                <b-card>
                    <b-form-group
                        :label="$t('gender')"
                        label-for="profile-gender"
                        label-cols-md="4"
                        label-cols-lg="3"
                        label-align-md="right"
                    >
                        <b-form-select
                            id="profile-gender"
                            v-model="o.gender"
                            :options="genders"
                            :disabled="savingGender"
                        ></b-form-select>
                    </b-form-group>
                    <b-button
                        variant="success"
                        block
                        @click="saveGender"
                        class="mt-3"
                        :disabled="savingGender"
                    >{{$t('save')}}</b-button>
                </b-card>
                <b-card class="mt-3" v-show="canSetEmail">
                    <email-confirmation v-model="o.emailConfirmed" :email="origEmail"></email-confirmation>
                    <hr />
                    <b-form-group
                        :label="$t('email')"
                        label-for="profile-email"
                        :invalid-feedback="invalidEmail"
                        :state="emailState"
                    >
                        <b-form-input v-model="o.email" trim id="profile-email" :disabled="settingEmail" dir="ltr"></b-form-input>
                    </b-form-group>
                    <b-form-group
                        :label="$t('password')"
                        label-for="profile-password-for-email"
                        :state="passwordState"
                        :invalid-feedback="invalidPassword"
                        v-show="readyToSetEmail"
                    >
                        <b-form-input
                            type="password"
                            id="profile-password-for-email"
                            v-model="password"
                            :disabled="settingEmail"
                            dir="ltr"
                        ></b-form-input>
                    </b-form-group>
                    <w-verify-code
                        v-model="verifyingEmail"
                        type="email"
                        :email="o.email"
                        :request-url="urlParser.localizeUrl('/api/usermanager/Profile/RequestCodeForSettingEmail').toRelative()"
                        :verify-url="urlParser.localizeUrl('/api/usermanager/Profile/VerifyCodeForSettingEmail').toRelative()"
                        @done="emailVerified"
                    ></w-verify-code>
                    <b-button
                        variant="primary"
                        block
                        @click="verifyEmail"
                        class="mt-3"
                        :disabled="verifyingEmail"
                        v-show="emailState && emailChanged && !readyToSetEmail"
                    >{{$t('verify-email')}}</b-button>
                    <b-button
                        variant="success"
                        block
                        @click="setEmail"
                        class="mt-3"
                        :disabled="settingEmail"
                        v-show="emailState && emailChanged && readyToSetEmail"
                    >{{$t('save')}}</b-button>
                </b-card>
            </div>
        </div>
    </b-card>
</template>

<script>
import loc from './Profile.i18n.json';
import { i18n } from "../../utility/VueI18n";
import { isEmail, isNumber } from "./util";
import EmailConfirmation from "./EmailConfirmation.vue";
import PhoneConfirmation from "./PhoneConfirmation.vue";
import { UrlParser } from "../../utility/url";
export default {
    i18n: i18n(loc),
    components: {
        EmailConfirmation,
        PhoneConfirmation
    },
    data() {
        return {
            urlParser: new UrlParser(),
            o: {
                name: '',
                gender: '',
                birthDateMs: moment().valueOf(),
                email: '',
                emailConfirmed: false,
                phone: {
                    phone: '',
                    countryCode: 'IR'
                },
                phoneConfirmed: false
            },
            genders: [
                { text: this.$t('male'), value: 'male' },
                { text: this.$t('female'), value: 'female' },
            ],
            origEmail: '',
            origPhone: {
                phone: '',
                countryCode: 'IR'
            },
            savingName: false,
            savingGender: false,
            savingBirthDate: false,
            canSetEmail: false,
            canSetPhone: false,
            settingEmail: false,
            settingPhone: false,
            password: '',
            verifyingEmail: false,
            verifyingPhone: false,
            readyToSetEmail: false,
            readyToSetPhone: false,
        };
    },
    async mounted() {
        try {
            const s = await this.$api.get('/api/usermanager/UserManager/VerificationCodeSendersStatus');
            this.canSetEmail = s.email;
            this.canSetPhone = s.sms;

            const data = await this.$api.get('/api/usermanager/Profile/GetInfo');
            this.o.name = data.name;
            this.o.gender = data.gender;
            this.o.birthDateMs = data.birthDateMs || moment().add('years', -30).valueOf();
            this.o.email = data.email;
            this.o.emailConfirmed = data.emailConfirmed;
            this.o.phone = Object.assign({}, data.phone);
            this.o.phoneConfirmed = data.phoneConfirmed;
            this.origEmail = this.o.email;
            this.origPhone = Object.assign({}, this.o.phone);
        } catch (error) {
            this.toastError(error);
            console.error(error);
        }
    },
    methods: {
        async saveName() {
            try {
                this.savingName = true;
                await this.$api.post('/api/usermanager/Profile/SetName', {
                    name: this.o.name
                });
                this.toastSuccess();
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.savingName = false;
            }
        },
        async saveGender() {
            try {
                this.savingGender = true;
                await this.$api.post('/api/usermanager/Profile/SetGender', {
                    isMale: this.o.gender === 'male'
                });
                this.toastSuccess();
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.savingGender = false;
            }
        },
        async saveBirthDate() {
            try {
                this.savingBirthDate = true;
                await this.$api.post('/api/usermanager/Profile/SetBirthDate', {
                    birthDateMs: this.o.birthDateMs
                });
                this.toastSuccess();
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.savingBirthDate = false;
            }
        },
        verifyEmail() {
            if (!isEmail(this.o.email)) {
                this.toastError(this.$t('invalid-email'));
                return;
            }
            this.verifyingEmail = true;
        },
        verifyPhone() {
            if (!isNumber(this.o.phone.phone)) {
                this.toastError(this.$t('invalid-phone'));
                return;
            }
            this.verifyingPhone = true;
        },
        emailVerified() {
            this.readyToSetEmail = true;
        },
        phoneVerified() {
            this.readyToSetPhone = true;
        },
        async setEmail() {
            try {
                this.settingEmail = true;
                var args = {
                    email: this.o.email,
                    password: this.password
                };
                await this.$api.post('/api/usermanager/Profile/SetEmail', args);
                this.o.emailConfirmed = true;
                this.toastSuccess();
                setTimeout(() => {
                    window.location.reload(true);
                }, 1000);
                return;
                // reset fields
                // this.origEmail = this.o.email;
                // this.password = '';
                // this.verifyingEmail = false;
                // this.readyToSetEmail = false;
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.settingEmail = false;
            }
        },
        async setPhone() {
            try {
                this.settingPhone = true;
                var args = {
                    phoneNational: this.o.phone.phone,
                    phoneCountryCode: this.o.phone.countryCode,
                    password: this.password
                };
                await this.$api.post('/api/usermanager/Profile/SetPhone', args);
                this.o.phoneConfirmed = true;
                this.toastSuccess();
                setTimeout(() => {
                    window.location.reload(true);
                }, 1000);
                return;
                // reset fields
                // this.origPhone = Object.assign({}, this.o.phone);
                // this.password = '';
                // this.verifyingPhone = false;
                // this.readyToSetPhone = false;
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.settingPhone = false;
            }
        },
    },
    computed: {
        nameState() {
            return this.o.name !== null && this.o.name.length > 0;
        },
        invalidName() {
            if (this.nameState) {
                return '';
            }
            return this.$t('invalidName');
        },
        phoneState() {
            var p = this.o.phone;
            return p !== undefined && p !== null && p.phone !== undefined && p.phone !== null && isNumber(p.phone);
        },
        invalidPhone() {
            if (this.phoneState) {
                return '';
            }
            return this.$t('invalid-phone');
        },
        emailState() {
            return this.o.email !== undefined && this.o.email !== null && this.o.email.length > 0 && isEmail(this.o.email);
        },
        invalidEmail() {
            if (this.emailState) {
                return '';
            }
            return this.$t('invalid-email');
        },
        passwordState() {
            return this.password !== undefined && this.password !== null && this.password.length > 0;
        },
        invalidPassword() {
            if (this.passwordState) {
                return '';
            }
            return this.$t('password-required');
        },
        emailChanged() {
            return this.origEmail !== this.o.email;
        },
        phoneChanged() {
            return !_.isEqual(this.origPhone, this.o.phone);
        },
    }
}
</script>