<template>
    <b-card :title="$t('title')">
        <w-data-table-client :rows="senders" :cols="senderCols" v-show="canView">
            <div slot="actions" class="mx-1">
                <b-button variant="success" @click="startAdd" v-show="canAdd">{{$t('add-sender')}}</b-button>
            </div>
            <span slot="id" slot-scope="a">{{a.value}}</span>
            <span slot="name" slot-scope="a">{{a.value}}</span>
            <span slot="type" slot-scope="a">{{a.value}}</span>
            <span slot="createDateTime" slot-scope="a">{{a.value}}</span>
            <span slot="updateDateTime" slot-scope="a">{{a.value}}</span>
            <span slot="description" slot-scope="a">{{$shorten(a.value, 15)}}</span>
            <span slot="opr" slot-scope="a">
                <b-button
                    variant="info"
                    size="sm"
                    class="mx-1 p-0"
                    v-show="canUpdate"
                    @click="startEdit(a.row)"
                    :title="$t('edit')"
                >
                    <w-mdi value="pencil" :size="18"></w-mdi>
                </b-button>
                <b-button
                    variant="danger"
                    size="sm"
                    class="mx-1 p-0"
                    v-show="canDelete"
                    @click="remove(a.row)"
                    :disabled="a.row.removing"
                    :title="$t('delete')"
                >
                    <w-mdi value="delete" :size="18"></w-mdi>
                </b-button>
            </span>
        </w-data-table-client>
        <b-modal v-model="editSenderModal.visible" :title="editSenderModal.title" size="xl" hide-footer>
            <b-form-group
                :label="$t('type')"
                label-for="sender-type"
                :state="senderTypeState"
                :invalid-feedback="invalidSenderType"
                label-cols-md="3"
                label-cols-lg="2"
                label-align-md="right"
            >
                <b-form-select
                    id="sender-type"
                    v-model="editSenderModal.model.type"
                    :options="executors"
                    value-field="type"
                    text-field="name"
                    @change="senderTypeChanged"
                    :disabled="!editSenderModal.isNew"
                ></b-form-select>
            </b-form-group>
            <b-form-group
                :label="$t('name')"
                label-for="sender-name"
                :state="senderNameState"
                :invalid-feedback="invalidSenderName"
                label-cols-md="3"
                label-cols-lg="2"
                label-align-md="right"
            >
                <b-form-input id="sender-name" v-model="editSenderModal.model.name" trim></b-form-input>
            </b-form-group>
            <b-form-group
                :label="$t('description')"
                label-for="sender-description"
                label-cols-md="3"
                label-cols-lg="2"
                label-align-md="right"
            >
                <b-form-textarea
                    id="sender-description"
                    v-model="editSenderModal.model.description"
                    rows="3"
                    max-rows="3"
                ></b-form-textarea>
            </b-form-group>
            <label>{{$t('configuration')}}</label>
            <w-json-editor :schema="editSenderModal.model.jsonSchema" v-model="editSenderModal.model.configurationJson"></w-json-editor>
            <b-button
                variant="success"
                class="mt-3"
                block
                @click="save"
                :disabled="editSenderModal.saving || (editSenderModal.isNew && !senderTypeState) || !senderNameState"
            >{{$t('save')}}</b-button>
        </b-modal>
    </b-card>
</template>

<script>
import loc from './SmsSenders.i18n.json';
import { i18n } from "../../utility/VueI18n";
import { dateHelper } from "../../utility/dateHelper";
export default {
    i18n: i18n(loc),
    data() {
        return {
            // array of {type, name, jsonSchema, jsonSchemaSampleObject, jsonSchemaSample}
            executors: [],
            // array of {id, createUtc, updateUtc, description, name, type, configurationJson, jsonSchema, removing}
            senders: [],
            senderCols: [
                { header: this.$t('id'), field: 'id', visible: false, sortable: false },
                { header: this.$t('name'), field: 'name' },
                { header: this.$t('type'), field: 'type' },
                { header: this.$t('createDateTime'), field: 'createDateTime' },
                { header: this.$t('updateDateTime'), field: 'updateDateTime' },
                { header: this.$t('description'), field: 'description', sortable: false },
                { header: this.$t('opr'), field: 'opr', sortable: false }
            ],
            editSenderModal: {
                title: '',
                visible: false,
                isNew: false,
                model: {
                    jsonSchema: '{}'
                }
            }
        };
    },
    async mounted() {
        await this.loadExecutors();
        await this.loadSenders();
    },
    methods: {
        parseSafe(json) {
            try {
                return JSON.parse(json);
            } catch {
                return {};
            }
        },
        convertSender(a) {
            a.createDateTime = dateHelper.formatTicks(a.createUtc);
            a.updateDateTime = dateHelper.formatTicks(a.updateUtc);
            a.jsonSchema = a.jsonSchema === undefined || a.jsonSchema === null || a.jsonSchema.length === 0 ? '{}' : a.jsonSchema;
            a.removing = false;
            return a;
        },
        convertExecutor(a) {
            a.jsonSchema = a.jsonSchema === null || a.jsonSchema.length === 0 ? '{}' : a.jsonSchema;
            a.jsonSchemaSample = a.jsonSchemaSampleObject === null || a.jsonSchemaSampleObject.length === 0 ?
                '{}' : JSON.stringify(a.jsonSchemaSampleObject);
            return a;
        },
        emptySender() {
            var nowTicks = moment().valueOf() * 10000;
            var res = {
                id: '',
                createUtc: nowTicks,
                updateUtc: nowTicks,
                description: '',
                type: '',
                name: '',
                configurationJson: '{}',
                jsonSchema: '{}'
            };
            return this.convertSender(res);
        },
        findExecutorByType(type) {
            var i = this.executors.findIndex(a => a.type === type);
            if (i > -1) {
                return this.executors[i];
            }
            return null;
        },
        findSenderIndexById(id) {
            return this.senders.findIndex(a => a.id === id);
        },
        startAdd() {
            this.editSenderModal.model = Object.assign({}, this.emptySender());
            this.editSenderModal.title = this.$t('add-new-sender');
            this.editSenderModal.isNew = true;
            this.editSenderModal.visible = true;
        },
        startEdit(item) {
            this.editSenderModal.model = Object.assign({}, this.emptySender(), item);
            this.editSenderModal.title = this.$t('edit-sender');
            this.editSenderModal.isNew = false;
            this.editSenderModal.visible = true;
        },
        async save() {
            try {
                var item = this.editSenderModal.model;
                this.editSenderModal.saving = true;
                if (this.editSenderModal.isNew) {
                    // add
                    var data = await this.$api.post('/api/smsing/SmsSender/Add', {
                        name: item.name,
                        type: item.type,
                        description: item.description,
                        configurationJson: item.configurationJson
                    });
                    this.senders.push(this.convertSender(data));
                } else {
                    // update
                    var data = await this.$api.post('/api/smsing/SmsSender/Update', {
                        id: item.id,
                        name: item.name,
                        type: item.type,
                        description: item.description,
                        configurationJson: item.configurationJson
                    });
                    var i = this.findSenderIndexById(data.id);
                    if (i > -1) {
                        this.$set(this.senders, i, this.convertSender(data));
                    }
                }
                this.toastSuccess();
                this.editSenderModal.visible = false;
            } catch (error) {
                this.toastError(error);
                console.error(error);
            } finally {
                this.editSenderModal.saving = false;
            }
        },
        async remove(item) {
            if (await this.toastAsk()) {
                try {
                    item.removing = true;
                    await this.$api.post('/api/smsing/SmsSender/Delete', {
                        id: item.id
                    });
                    var i = this.findSenderIndexById(item.id);
                    if (i > -1) {
                        this.senders.splice(i, 1);
                    }
                    this.toastSuccess();
                } catch (error) {
                    this.toastError(error);
                    console.error(error);
                } finally {
                    item.removing = false;
                }
            }
        },
        async loadSenders() {
            this.senders.splice(0, this.senders.length);
            try {
                var senders = await this.$api.get('/api/smsing/SmsSender/GetAll');
                senders.forEach(s => {
                    this.senders.push(this.convertSender(s));
                });
            } catch (ex) {
                console.error(ex);
            }
        },
        async loadExecutors() {
            this.executors.splice(0, this.executors.length);
            try {
                var executors = await this.$api.get('/api/smsing/SmsSenderExecutor/GetAll', null);
                executors.forEach(e => {
                    this.executors.push(this.convertExecutor(e));
                });
            } catch (ex) {
                console.error(ex);
            }
        },
        senderTypeChanged(type) {
            var item = this.editSenderModal.model;
            var executor = this.findExecutorByType(type);
            if (executor === null) {
                item.jsonSchema = '{}';
                item.configurationJson = '{}';
                return;
            }
            item.jsonSchema = executor.jsonSchema;
            item.configurationJson = executor.jsonSchemaSample;
        }
    },
    computed: {
        canView() {
            return this.$user.hasAccessAll(["smsing_ViewSmsSenderExecutors", "smsing_ViewSmsSenders"]);
        },
        canAdd() {
            return this.$user.hasAccess("smsing_AddSmsSenders");
        },
        canUpdate() {
            return this.$user.hasAccess("smsing_UpdateSmsSenders");
        },
        canDelete() {
            return this.$user.hasAccess("smsing_DeleteSmsSenders");
        },
        senderNameState() {
            var a = this.editSenderModal.model.name;
            return a === undefined || a === null || a.length === 0 ? false : true;
        },
        invalidSenderName() {
            if (this.senderNameState) {
                return '';
            }
            return this.$t('sender-name-required');
        },
        senderTypeState() {
            var a = this.editSenderModal.model.type;
            return a === undefined || a === null || a.length === 0 ? false : true;
        },
        invalidSenderType() {
            if (this.senderTypeState) {
                return '';
            }
            return this.$t('sender-type-required');
        }
    },
}
</script>